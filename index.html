<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMR Architect Pro | Enterprise Edition</title>
    <meta name="description" content="Professional Industrial OMR Sheet Generator.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: '#3b82f6',
                        accent: '#6366f1',
                        dark: { bg: '#0f172a', surface: '#1e293b', border: '#334155' },
                        omr: { red: '#ef4444', black: '#000000' } // Using standard OMR drop-out red
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto+Mono:wght@400;700&display=swap');

        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        /* Form Elements */
        .input-group { margin-bottom: 0.75rem; }
        .input-label { display: block; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: 0.25rem; letter-spacing: 0.05em; }
        .input-modern {
            background: #1e293b; border: 1px solid #334155; color: white;
            padding: 8px 12px; border-radius: 6px; width: 100%; font-size: 0.85rem;
            transition: all 0.2s;
        }
        .input-modern:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); outline: none; }
        
        /* Tabs */
        .tab-btn { padding: 8px; flex: 1; text-align: center; font-size: 0.8rem; color: #94a3b8; border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; font-weight: 600; }

        /* --- OMR SHEET (A4 PHYSICAL DIMENSIONS) --- */
        #preview-area {
            background-color: #334155;
            background-image: 
                linear-gradient(45deg, #3b485e 25%, transparent 25%), 
                linear-gradient(-45deg, #3b485e 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #3b485e 75%), 
                linear-gradient(-45deg, transparent 75%, #3b485e 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            overflow: auto; height: 100vh; display: flex; justify-content: center; padding: 3rem; align-items: flex-start;
        }

        .sheet {
            width: 210mm; height: 297mm; /* Exact A4 */
            background: white; color: black; position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            padding: 10mm; box-sizing: border-box;
            display: flex; flex-direction: column;
            transform-origin: top center; transition: transform 0.2s ease;
        }

        /* OMR Specifics */
        .omr-color { color: #ef4444; border-color: #ef4444; } /* Drop-out Red */
        .bubble {
            width: 13px; height: 13px;
            border: 1px solid #ef4444; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 8.5px; color: #ef4444; font-weight: bold; font-family: 'Roboto Mono', monospace;
        }
        
        /* Timing Track - Critical for Scanning */
        .timing-mark { width: 100%; height: 4px; background: black; border-radius: 1px; }
        .timing-slot { height: 20px; display: flex; align-items: center; } /* Matches Grid Row Height */

        /* Watermark */
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8rem; font-weight: 900; color: rgba(0,0,0,0.03); pointer-events: none; white-space: nowrap;
            z-index: 0;
        }

        /* Fiducials (Scanning Anchors) */
        .fid { position: absolute; width: 25px; height: 25px; border: 6px solid black; z-index: 50; }
        .fid-tl { top: 6mm; left: 6mm; border-right: 0; border-bottom: 0; }
        .fid-tr { top: 6mm; right: 6mm; border-left: 0; border-bottom: 0; }
        .fid-bl { bottom: 6mm; left: 6mm; border-right: 0; border-top: 0; }
        .fid-br { bottom: 6mm; right: 6mm; border-left: 0; border-top: 0; }

        /* --- PRINT MEDIA QUERY --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; overflow: visible; }
            body * { visibility: hidden; }
            #sheet-el, #sheet-el * { visibility: visible; }
            #sheet-el {
                position: fixed; left: 0; top: 0; width: 210mm; height: 297mm;
                margin: 0; padding: 10mm; transform: none !important;
                box-shadow: none; border: none;
            }
            /* Hide non-printable UI elements */
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="flex h-screen w-full">
        <aside class="w-96 bg-dark-bg border-r border-dark-border flex flex-col z-50 shadow-2xl">
            <div class="p-4 border-b border-dark-border bg-dark-surface/50 backdrop-blur">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded bg-gradient-to-br from-brand to-accent flex items-center justify-center text-white text-xl shadow-lg shadow-brand/20">
                        <i class="fa-solid fa-shapes"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-white text-lg leading-tight">OMR Architect</h1>
                        <p class="text-[10px] text-gray-400 font-mono">PRO VERSION 2.0</p>
                    </div>
                </div>
            </div>

            <div class="flex border-b border-dark-border bg-dark-bg">
                <div onclick="switchTab('basic')" id="tab-basic" class="tab-btn active">Basic Info</div>
                <div onclick="switchTab('grid')" id="tab-grid" class="tab-btn">Grid & Layout</div>
                <div onclick="switchTab('style')" id="tab-style" class="tab-btn">Styling</div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-24 space-y-6">

                <div id="content-basic" class="tab-content">
                    <div class="input-group">
                        <label class="input-label">Institute Name</label>
                        <input type="text" id="inp-inst" class="input-modern font-bold" value="ALAN TURING ACADEMY">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Exam Title</label>
                        <input type="text" id="inp-exam" class="input-modern" value="NATIONAL TALENT SEARCH 2026">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label class="input-label">Date</label>
                            <input type="text" id="inp-date" class="input-modern" value="24 JAN 2026">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Exam Code</label>
                            <input type="text" id="inp-code" class="input-modern" value="PCM-2026-A">
                        </div>
                    </div>

                    <div class="pt-4 border-t border-dark-border mt-4">
                        <label class="input-label">Student Data Fields</label>
                        <div id="field-list-container" class="space-y-2 mb-2"></div>
                        <button onclick="addNewField()" class="w-full py-2 border border-dashed border-gray-600 rounded text-xs text-gray-400 hover:text-white hover:border-brand hover:bg-dark-surface transition">
                            <i class="fa-solid fa-plus mr-1"></i> Add Data Field
                        </button>
                    </div>
                </div>

                <div id="content-grid" class="tab-content hidden">
                    <div class="bg-dark-surface p-4 rounded-lg border border-dark-border space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-semibold">Total Questions</label>
                            <input type="number" id="inp-total" class="input-modern w-24 text-center font-mono" value="90">
                        </div>

                        <div class="flex justify-between items-center">
                            <label class="text-sm font-semibold">Columns layout</label>
                            <div class="bg-dark-bg p-1 rounded border border-dark-border flex">
                                <button onclick="setCols(4)" id="btn-col-4" class="px-3 py-1 text-xs rounded transition bg-brand text-white">4</button>
                                <button onclick="setCols(5)" id="btn-col-5" class="px-3 py-1 text-xs rounded transition hover:text-white">5</button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <label class="text-sm font-semibold">Options (Bubbles)</label>
                            <select id="inp-opts" class="input-modern w-24 py-1 h-8 text-xs">
                                <option value="4">A B C D</option>
                                <option value="5">A B C D E</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="input-label mb-2">Section Headers (Optional)</label>
                        <p class="text-[10px] text-gray-500 mb-2">Format: "Title:StartQ". Ex: "Physics:1"</p>
                        <textarea id="inp-sections" class="input-modern h-24 font-mono text-xs" placeholder="Physics:1&#10;Chemistry:31&#10;Maths:61">Physics:1
Chemistry:31
Mathematics:61</textarea>
                    </div>

                    <div class="pt-4 border-t border-dark-border mt-4">
                        <label class="input-label">Machine Codes</label>
                        <input type="text" id="inp-qr" class="input-modern mb-2" value="BATCH-2026-X">
                        <input type="text" id="inp-bar" class="input-modern" value="1029384756">
                    </div>
                </div>

                <div id="content-style" class="tab-content hidden">
                    <div class="input-group">
                        <label class="input-label">Institute Logo</label>
                        <div class="relative">
                            <input type="file" id="inp-logo" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleLogo(this)">
                            <div class="input-modern flex items-center justify-center gap-2 hover:bg-dark-surface cursor-pointer text-gray-400">
                                <i class="fa-solid fa-cloud-arrow-up"></i> <span id="logo-filename">Upload PNG/JPG</span>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Watermark Text</label>
                        <input type="text" id="inp-watermark" class="input-modern" value="CONFIDENTIAL">
                    </div>

                    <div class="input-group">
                        <label class="input-label">Color Theme</label>
                        <div class="grid grid-cols-4 gap-2">
                            <div onclick="setTheme('#ef4444')" class="h-8 rounded cursor-pointer bg-red-500 border-2 border-white ring-2 ring-red-500"></div>
                            <div onclick="setTheme('#ea580c')" class="h-8 rounded cursor-pointer bg-orange-600 border border-gray-600"></div>
                            <div onclick="setTheme('#059669')" class="h-8 rounded cursor-pointer bg-emerald-600 border border-gray-600"></div>
                            <div onclick="setTheme('#2563eb')" class="h-8 rounded cursor-pointer bg-blue-600 border border-gray-600"></div>
                        </div>
                    </div>
                    
                    <button onclick="resetData()" class="w-full mt-6 py-2 text-xs text-red-400 border border-red-900/50 rounded hover:bg-red-900/20">
                        <i class="fa-solid fa-triangle-exclamation"></i> Factory Reset
                    </button>
                </div>

            </div>

            <div class="absolute bottom-0 left-0 w-full p-4 bg-dark-bg border-t border-dark-border grid grid-cols-2 gap-3">
                <button onclick="saveProject()" id="btn-save" class="bg-dark-surface text-gray-300 py-2 rounded font-bold border border-gray-600 hover:text-white hover:border-gray-400 text-sm transition">
                    <i class="fa-solid fa-floppy-disk"></i> Save
                </button>
                <button onclick="printSheet()" class="bg-brand text-white py-2 rounded font-bold shadow-lg shadow-blue-500/20 hover:bg-blue-600 text-sm transition">
                    <i class="fa-solid fa-print"></i> Print / PDF
                </button>
            </div>
        </aside>

        <main id="preview-area" class="flex-1 relative">
            
            <div class="fixed top-4 right-8 z-40 bg-dark-surface/90 backdrop-blur rounded-full px-2 py-1 border border-dark-border flex items-center gap-2 shadow-xl text-white">
                <button onclick="zoom(-0.1)" class="w-8 h-8 flex items-center justify-center hover:text-brand rounded-full"><i class="fa-solid fa-minus"></i></button>
                <span id="zoom-disp" class="text-xs font-mono w-12 text-center select-none">100%</span>
                <button onclick="zoom(0.1)" class="w-8 h-8 flex items-center justify-center hover:text-brand rounded-full"><i class="fa-solid fa-plus"></i></button>
                <div class="w-[1px] h-4 bg-gray-600 mx-1"></div>
                <button onclick="renderSheet()" class="w-8 h-8 flex items-center justify-center hover:text-brand rounded-full" title="Refresh"><i class="fa-solid fa-rotate"></i></button>
            </div>

            <div id="sheet-el" class="sheet">
                <div id="watermark-target" class="watermark">CONFIDENTIAL</div>

                <div class="fid fid-tl"></div><div class="fid fid-tr"></div>
                <div class="fid fid-bl"></div><div class="fid fid-br"></div>

                <header class="flex justify-between items-stretch border-b-2 omr-color pb-3 mb-2 z-10 relative">
                    <div class="w-24 h-24 border border-gray-200 flex items-center justify-center text-[10px] text-gray-300 overflow-hidden bg-white">
                        <img id="logo-target" src="" class="object-contain w-full h-full hidden">
                        <span id="logo-placeholder">LOGO</span>
                    </div>
                    
                    <div class="text-center flex-1 px-4 flex flex-col justify-center">
                        <h1 class="text-3xl font-black uppercase tracking-tight scale-y-110 leading-none" id="out-inst">INSTITUTE</h1>
                        <h2 class="text-lg font-bold omr-color uppercase mt-1 tracking-widest" id="out-exam">EXAM</h2>
                        <div class="flex justify-center gap-8 text-[11px] mt-2 font-mono text-gray-600">
                            <span class="border-b border-gray-300 px-2">DATE: <b id="out-date" class="text-black"></b></span>
                            <span class="border-b border-gray-300 px-2">CODE: <b id="out-code" class="text-black"></b></span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col justify-between items-end">
                         <div id="qr-target" class="p-1 bg-white"></div>
                    </div>
                </header>

                <div class="flex gap-4 mb-3 flex-shrink-0 z-10 relative">
                    <div class="flex-1 flex flex-col gap-2" id="dynamic-fields-target">
                        </div>
                    
                    <div class="w-56 border omr-color p-2 flex flex-col">
                        <div class="text-center text-[10px] font-bold omr-color mb-1 tracking-widest">ROLL NO.</div>
                        <div class="flex-1 flex justify-center gap-[3px]" id="roll-target"></div>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-2 flex-shrink-0 z-10 relative">
                    <div class="text-[9px] text-gray-500 leading-tight w-2/3 pr-4 text-justify">
                        <b>INSTRUCTIONS:</b> 
                        1. Use Blue/Black Ball Point Pen only. 
                        2. Darken the circle completely. 
                        3. Darken only one circle for each question. 
                        4. Do not fold or tear this answer sheet. 
                        5. Erasing or using white fluid is strictly prohibited.
                    </div>
                    <div class="flex flex-col items-end">
                        <svg id="barcode-target"></svg>
                    </div>
                </div>

                <div class="flex-grow border-t-2 border-b-2 omr-color relative py-2 flex" id="grid-container">
                     <div class="absolute -left-5 top-0 bottom-0 w-3 py-2 flex flex-col justify-between" id="timing-track-left"></div>
                     
                     <div class="w-full flex" id="grid-target"></div>
                     
                     </div>

                <footer class="h-16 grid grid-cols-3 gap-6 mt-3 z-10 relative">
                    <div class="border border-gray-400 relative">
                        <span class="absolute bottom-1 left-0 right-0 text-center text-[8px] uppercase text-gray-500">Candidate Signature</span>
                    </div>
                    <div class="border border-gray-400 relative">
                         <span class="absolute bottom-1 left-0 right-0 text-center text-[8px] uppercase text-gray-500">Invigilator Signature</span>
                    </div>
                    <div class="border border-gray-400 flex items-center justify-center bg-gray-50">
                        <span class="text-[9px] text-gray-300 font-bold transform -rotate-12 border-2 border-gray-200 p-1 rounded">OFFICIAL STAMP</span>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURATION & STATE ---
        const DEFAULT_FIELDS = [
            {id: 1, name: "CANDIDATE NAME"},
            {id: 2, name: "MOBILE NUMBER"},
            {id: 3, name: "CENTER NAME"}
        ];

        let state = {
            scale: 1.0,
            cols: 4,
            fields: JSON.parse(JSON.stringify(DEFAULT_FIELDS)), // deep copy
            themeColor: '#ef4444'
        };

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            loadProject(); // Load from LocalStorage if available
            
            // Attach Listeners
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', () => {
                    renderSheet();
                    autoSave(); // Debounce this in prod, but fine for now
                });
            });

            // Initial Render
            updateColButtons();
            renderFieldsUI();
            renderSheet();
        });

        // --- CORE RENDERER ---
        function renderSheet() {
            // 1. Text Mapping
            document.getElementById('out-inst').innerText = document.getElementById('inp-inst').value;
            document.getElementById('out-exam').innerText = document.getElementById('inp-exam').value;
            document.getElementById('out-date').innerText = document.getElementById('inp-date').value;
            document.getElementById('out-code').innerText = document.getElementById('inp-code').value;
            document.getElementById('watermark-target').innerText = document.getElementById('inp-watermark').value;

            // 2. Theme Coloring
            document.documentElement.style.setProperty('--omr-color', state.themeColor);
            const colorEls = document.querySelectorAll('.omr-color');
            colorEls.forEach(el => {
                el.style.borderColor = state.themeColor;
                if(el.classList.contains('text-lg') || el.classList.contains('text-[10px]')) {
                    el.style.color = state.themeColor;
                }
            });

            // 3. Dynamic Fields
            const fieldContainer = document.getElementById('dynamic-fields-target');
            fieldContainer.innerHTML = state.fields.map(f => `
                <div class="flex border omr-color h-8 bg-white">
                    <div class="bg-[${state.themeColor}] text-white px-3 text-[9px] font-bold w-32 flex items-center uppercase leading-none tracking-wide" style="background-color: ${state.themeColor}">${f.name}</div>
                    <div class="flex-1 p-1 relative">
                        <div class="absolute bottom-2 left-2 right-2 border-b border-dotted border-gray-400"></div>
                    </div>
                </div>
            `).join('');

            // 4. Roll Number (7 Columns x 10 Rows)
            let rollHTML = '';
            for(let i=0; i<7; i++) {
                rollHTML += `<div class="flex flex-col gap-[2px]">
                    <div class="w-5 h-6 border border-gray-300 mb-1 rounded-[2px]"></div>
                    ${[0,1,2,3,4,5,6,7,8,9].map(n => `<span class="bubble" style="border-color:${state.themeColor}; color:${state.themeColor}">${n}</span>`).join('')}
                </div>`;
            }
            document.getElementById('roll-target').innerHTML = rollHTML;

            // 5. Codes
            const qrBox = document.getElementById('qr-target');
            qrBox.innerHTML = '';
            new QRCode(qrBox, { text: document.getElementById('inp-qr').value, width: 60, height: 60, correctLevel: QRCode.CorrectLevel.L });
            
            JsBarcode("#barcode-target", document.getElementById('inp-bar').value, {
                height: 30, width: 1.5, displayValue: true, fontSize: 10, margin: 0, lineColor: "#000"
            });

            // 6. GRID ENGINE (The Complex Part)
            renderGrid();
        }

        function renderGrid() {
            const total = parseInt(document.getElementById('inp-total').value) || 0;
            const opts = parseInt(document.getElementById('inp-opts').value);
            const cols = state.cols;
            const perCol = Math.ceil(total / cols);
            const optChars = ['A','B','C','D','E'].slice(0, opts);
            
            // Section Parsing
            const sectionText = document.getElementById('inp-sections').value;
            const sections = {}; // Map: startQ -> Title
            sectionText.split('\n').forEach(line => {
                const parts = line.split(':');
                if(parts.length === 2) {
                    sections[parseInt(parts[1].trim())] = parts[0].trim();
                }
            });

            let gridHTML = '';
            let timingTrackHTML = '';

            // Grid Styling Constants
            const rowHeightClass = "h-5"; // 20px height per question
            
            for(let c=0; c<cols; c++) {
                gridHTML += `<div class="flex-1 border-r last:border-0 border-gray-300 px-2 flex flex-col h-full">
                    <div class="flex text-[9px] font-bold border-b-2 border-gray-800 mb-1 pb-1">
                        <span class="w-6 text-center">Q.</span>
                        <span class="flex-1 text-center">Answer</span>
                    </div>
                    <div class="flex-1 flex flex-col">`; // Start Col Body

                for(let i=0; i<perCol; i++) {
                    const qNum = (c * perCol) + i + 1;
                    
                    // Render Question
                    if(qNum <= total) {
                        // Check for Section Header
                        if(sections[qNum]) {
                            gridHTML += `<div class="bg-gray-100 text-[10px] font-bold text-center border-y border-gray-300 my-1 py-[2px] uppercase tracking-wider text-gray-700">${sections[qNum]}</div>`;
                            // Note: Section headers disrupt 1:1 timing track alignment if not handled carefully. 
                            // In this pro version, we place track marks relative to the bubbles, not absolute page position.
                        }

                        gridHTML += `<div class="${rowHeightClass} flex items-center justify-between">
                            <span class="w-6 text-[10px] font-bold text-right pr-2 text-gray-600 font-mono">${qNum}</span>
                            <div class="flex gap-1.5 justify-center flex-1">
                                ${optChars.map(o => `<span class="bubble" style="border-color:${state.themeColor}; color:${state.themeColor}">${o}</span>`).join('')}
                            </div>
                        </div>`;

                        // Add Timing Mark for this specific row (only for the first column's worth of height, actually needed for all)
                        // Actually, timing tracks are usually on the left edge of the SHEET, corresponding to ANY mark on that horizontal line.
                        // For a multi-column OMR, the timing track usually maps to the rows. 
                        // Since we are using flexbox columns, we need to generate the track separately or ensure row heights are rigid.
                        // Approach: We will rely on CSS flex distribution, but strict height is safer.
                    } else {
                        gridHTML += `<div class="${rowHeightClass}"></div>`; // Spacer
                    }
                }
                gridHTML += `</div></div>`;
            }
            document.getElementById('grid-target').innerHTML = gridHTML;

            // Generate Timing Track (Left side)
            // It needs one black mark for every "row slot" available in the column height.
            // Since we used a fixed height class (h-5 = 20px) + spacing, we can calculate or emulate.
            // Simplified utility: Generate ~50 marks to cover the area.
            timingTrackHTML = '';
            // We want marks to align with the rows.
            // In a pro engine, we'd calculate exactly. Here visually, we use the same height class.
            // We add a 'header offset' to align with the first question.
            timingTrackHTML += `<div class="h-6"></div>`; // Header offset
            for(let i=0; i<perCol; i++) {
                 timingTrackHTML += `<div class="${rowHeightClass} flex items-center"><div class="timing-mark"></div></div>`;
            }
            document.getElementById('timing-track-left').innerHTML = timingTrackHTML;
        }


        // --- UTILITIES ---

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('content-' + tabId).classList.remove('hidden');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        function zoom(amount) {
            state.scale = Math.max(0.5, Math.min(2.0, state.scale + amount));
            document.getElementById('zoom-disp').innerText = Math.round(state.scale * 100) + '%';
            document.getElementById('sheet-el').style.transform = `scale(${state.scale})`;
        }

        function setCols(n) {
            state.cols = n;
            updateColButtons();
            renderSheet();
        }

        function updateColButtons() {
            document.getElementById('btn-col-4').className = `px-3 py-1 text-xs rounded transition ${state.cols === 4 ? 'bg-brand text-white' : 'hover:bg-gray-700'}`;
            document.getElementById('btn-col-5').className = `px-3 py-1 text-xs rounded transition ${state.cols === 5 ? 'bg-brand text-white' : 'hover:bg-gray-700'}`;
        }

        function setTheme(color) {
            state.themeColor = color;
            renderSheet();
        }

        // --- FIELD MANAGER ---
        function addNewField() {
            const name = prompt("Enter Field Label (e.g. CASTE, FATHER'S NAME):");
            if(name) {
                state.fields.push({id: Date.now(), name: name.toUpperCase()});
                renderFieldsUI();
                renderSheet();
            }
        }

        function removeField(id) {
            state.fields = state.fields.filter(f => f.id !== id);
            renderFieldsUI();
            renderSheet();
        }

        function renderFieldsUI() {
            document.getElementById('field-list-container').innerHTML = state.fields.map(f => `
                <div class="flex justify-between items-center bg-dark-bg p-2 rounded text-xs border border-dark-border group">
                    <span class="font-mono">${f.name}</span>
                    <button onclick="removeField(${f.id})" class="text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        // --- FILE HANDLING ---
        function handleLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logo-target').src = e.target.result;
                    document.getElementById('logo-target').classList.remove('hidden');
                    document.getElementById('logo-placeholder').classList.add('hidden');
                    document.getElementById('logo-filename').innerText = input.files[0].name;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- PERSISTENCE (UTILITY POWER UP) ---
        function saveProject() {
            const data = {
                fields: state.fields,
                inputs: {
                    inst: document.getElementById('inp-inst').value,
                    exam: document.getElementById('inp-exam').value,
                    date: document.getElementById('inp-date').value,
                    code: document.getElementById('inp-code').value,
                    total: document.getElementById('inp-total').value,
                    sections: document.getElementById('inp-sections').value,
                    watermark: document.getElementById('inp-watermark').value
                }
            };
            localStorage.setItem('omr_project_v2', JSON.stringify(data));
            
            // Visual Feedback
            const btn = document.getElementById('btn-save');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
            btn.classList.add('text-green-400', 'border-green-500');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('text-green-400', 'border-green-500');
            }, 1500);
        }

        function loadProject() {
            const stored = localStorage.getItem('omr_project_v2');
            if(stored) {
                const data = JSON.parse(stored);
                if(data.fields) state.fields = data.fields;
                if(data.inputs) {
                    document.getElementById('inp-inst').value = data.inputs.inst || "";
                    document.getElementById('inp-exam').value = data.inputs.exam || "";
                    document.getElementById('inp-date').value = data.inputs.date || "";
                    document.getElementById('inp-code').value = data.inputs.code || "";
                    document.getElementById('inp-total').value = data.inputs.total || 90;
                    document.getElementById('inp-sections').value = data.inputs.sections || "";
                    document.getElementById('inp-watermark').value = data.inputs.watermark || "";
                }
                renderFieldsUI();
            }
        }

        function autoSave() {
            // Simple auto-save wrapper
            saveProject();
        }

        function resetData() {
            if(confirm("Reset all settings to default? This cannot be undone.")) {
                localStorage.removeItem('omr_project_v2');
                location.reload();
            }
        }

        function printSheet() {
            window.print();
        }

    </script>
</body>
</html>
