<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMR GENERATOR PRO | Mobile Edition</title>
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <script src="https://cdn.tailwindcss.com" data-cfasync="false"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" data-cfasync="false"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" data-cfasync="false"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js" data-cfasync="false"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" data-cfasync="false"></script>

    <script data-cfasync="false">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#050505',
                        panel: '#121212',
                        neon: '#00f2ea',
                        neonh: '#00c2bb',
                        pink: '#ff0055',
                        grid: '#1a1a1a'
                    },
                    fontFamily: {
                        mono: ['Courier New', 'monospace'],
                        sans: ['Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE OMR STYLES (Print Safe) --- */
        :root { --dropout: #ec4899; }
        
        body { background: #050505; color: #fff; touch-action: manipulation; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* OMR Sheet Physics */
        #sheet-viewport {
            transform-origin: top center;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }

        .omr-sheet {
            width: 210mm;
            height: 297mm;
            background: white;
            color: black;
            position: relative;
            padding: 10mm;
            box-sizing: border-box;
            font-family: sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* OMR Components */
        .bubble {
            width: 14px; height: 14px;
            border: 1.5px solid var(--dropout);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: bold; color: var(--dropout);
            font-family: monospace;
        }
        .write-box {
            width: 16px; height: 20px;
            border: 1.5px solid var(--dropout);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: black; font-family: monospace;
            margin-bottom: 2px;
        }
        
        /* Fiducials (Scantron Markers) */
        .fid { position: absolute; background: black; z-index: 50; }
        .fid-tl { top: 6mm; left: 6mm; width: 20px; height: 6px; }
        .fid-tl-v { top: 6mm; left: 6mm; width: 6px; height: 20px; }
        .fid-tr { top: 6mm; right: 6mm; width: 20px; height: 6px; }
        .fid-bl { bottom: 6mm; left: 6mm; width: 20px; height: 6px; }
        .fid-br { bottom: 6mm; right: 6mm; width: 20px; height: 6px; }
        
        /* Timing Track */
        .track { 
            position: absolute; left: 5mm; top: 40mm; bottom: 20mm; 
            width: 4px; display: flex; flex-direction: column; justify-content: space-evenly; 
        }
        .track-mark { width: 100%; height: 3px; background: black; }

        /* Input Styling */
        .cyber-input {
            background: #1a1a1a; border: 1px solid #333;
            color: #00f2ea; padding: 10px; width: 100%;
            border-radius: 4px; font-family: monospace;
            outline: none;
        }
        .cyber-input:focus { border-color: #00f2ea; box-shadow: 0 0 10px rgba(0,242,234,0.2); }
        
        /* Tab System */
        .tab-btn {
            flex: 1; padding: 15px; text-align: center;
            background: #121212; border-bottom: 2px solid #333;
            color: #666; font-weight: bold; cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            border-bottom: 2px solid #00f2ea;
            color: #00f2ea; background: #0a0a0a;
        }

        /* Print Hiding */
        @media print {
            body * { visibility: hidden; }
            #sheet-viewport, #sheet-viewport * { visibility: visible; }
            #sheet-viewport { 
                position: absolute; left: 0; top: 0; 
                width: 210mm !important; height: 297mm !important; 
                transform: none !important; margin: 0 !important;
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col lg:flex-row overflow-hidden">

    <div class="flex lg:hidden z-50 sticky top-0 bg-dark shadow-lg">
        <div onclick="switchTab('config')" id="tab-config" class="tab-btn active"><i class="fa-solid fa-sliders"></i> CONFIG</div>
        <div onclick="switchTab('preview')" id="tab-preview" class="tab-btn"><i class="fa-solid fa-eye"></i> PREVIEW</div>
    </div>

    <aside id="panel-config" class="w-full lg:w-[400px] bg-panel border-r border-[#222] flex flex-col h-full overflow-y-auto pb-20 lg:pb-0">
        <div class="p-6 space-y-6">
            <div class="flex items-center gap-3 mb-4">
                <i class="fa-solid fa-cube text-neon text-2xl animate-pulse"></i>
                <h1 class="text-xl font-bold tracking-wider">OMR <span class="text-neon">GEN</span> v4</h1>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Institute Name</label>
                    <input type="text" id="inp-institute" class="cyber-input" value="SKYNET UNIVERSITY">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Exam Name</label>
                    <input type="text" id="inp-exam" class="cyber-input" value="ENTRANCE EXAM 2026">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1">Total Qs</label>
                        <input type="number" id="inp-total" class="cyber-input text-center" value="50">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1">Columns</label>
                        <select id="inp-cols" class="cyber-input text-center">
                            <option value="2">2 Columns</option>
                            <option value="3">3 Columns</option>
                            <option value="4" selected>4 Columns</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1">Options</label>
                        <select id="inp-opts" class="cyber-input text-center">
                            <option value="4">A B C D</option>
                            <option value="5">A B C D E</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1">Roll Digits</label>
                        <input type="number" id="inp-roll" class="cyber-input text-center" value="8">
                    </div>
                </div>

                <div class="border border-dashed border-[#444] rounded p-4 text-center cursor-pointer hover:border-neon transition bg-[#0f0f0f] relative group">
                    <input type="file" id="inp-logo" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <i class="fa-solid fa-cloud-arrow-up text-gray-500 text-xl mb-2 group-hover:text-neon"></i>
                    <p class="text-xs text-gray-400">Tap to Upload Logo</p>
                </div>
            </div>

            <div class="pt-6 border-t border-[#222]">
                <button onclick="downloadPDF()" id="btn-dl" class="w-full bg-gradient-to-r from-neon to-blue-500 text-black font-bold py-4 rounded shadow-[0_0_15px_rgba(0,242,234,0.3)] active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-pdf text-lg"></i> DOWNLOAD PDF
                </button>
                <p class="text-[10px] text-gray-600 text-center mt-2">100% Client-Side. No Data Uploaded.</p>
            </div>
        </div>
    </aside>

    <main id="panel-preview" class="flex-grow bg-[#080808] relative hidden lg:flex items-center justify-center overflow-hidden">
        
        <div class="absolute top-4 right-4 bg-panel px-3 py-1 rounded border border-[#333] text-xs font-mono text-neon z-20 pointer-events-none">
            Scale: <span id="scale-indicator">100%</span>
        </div>

        <div class="w-full h-full overflow-auto flex items-start justify-center p-4 lg:p-10" id="scroll-container">
            
            <div id="sheet-viewport">
                
                <div class="omr-sheet" id="omr-content">
                    <div class="fid fid-tl"></div><div class="fid fid-tl-v"></div>
                    <div class="fid fid-tr"></div>
                    <div class="fid fid-bl"></div>
                    <div class="fid fid-br"></div>
                    
                    <div class="track" id="track-container"></div>

                    <header class="flex gap-4 border-b-2 border-pink-500 pb-3 mb-3 h-[30mm]">
                        <div class="w-[25mm] border border-gray-300 flex items-center justify-center p-1 bg-white">
                            <img id="img-logo-preview" class="max-w-full max-h-full object-contain hidden">
                            <span id="logo-placeholder" class="text-[8px] text-gray-300 text-center">LOGO</span>
                        </div>
                        <div class="flex-grow flex flex-col justify-center">
                            <h1 id="out-institute" class="text-2xl font-black text-pink-600 uppercase leading-none">INSTITUTE</h1>
                            <h2 id="out-exam" class="text-sm font-bold text-gray-700 mt-1 uppercase tracking-widest">EXAM NAME</h2>
                        </div>
                        <div class="flex flex-col items-end justify-center">
                             <div id="qr-code"></div>
                        </div>
                    </header>

                    <section class="flex gap-4 mb-4">
                        <div class="flex flex-col">
                            <div class="bg-pink-600 text-white text-[8px] font-bold text-center py-0.5 w-full">ROLL NO.</div>
                            <div class="border border-pink-600 border-t-0 p-1 flex gap-[2px]" id="roll-grid"></div>
                        </div>
                        
                        <div class="flex-grow border border-gray-300 p-2 relative">
                            <span class="absolute -top-2 left-2 bg-white px-1 text-[8px] font-bold text-gray-500">CANDIDATE NAME (BLOCK LETTERS)</span>
                            <div class="grid grid-cols-10 gap-1 mt-2">
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                                <div class="h-6 border border-gray-300 bg-gray-50"></div>
                            </div>
                        </div>
                    </section>

                    <div class="flex-grow border-t border-pink-300 pt-2 relative">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-white px-2 text-[10px] text-pink-500 font-bold">ANSWERS</div>
                        <div id="q-grid" class="grid h-full content-start gap-x-6"></div>
                    </div>

                    <footer class="h-[20mm] border-t border-black mt-2 flex items-end justify-between pt-2">
                        <div class="flex gap-4 w-2/3">
                            <div class="border border-gray-400 h-10 w-1/2 relative">
                                <span class="absolute top-0 left-1 text-[6px] text-gray-500 uppercase">Signature of Candidate</span>
                            </div>
                            <div class="border border-gray-400 h-10 w-1/2 relative">
                                <span class="absolute top-0 left-1 text-[6px] text-gray-500 uppercase">Signature of Invigilator</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <svg id="barcode"></svg>
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </main>

    <script data-cfasync="false">
        const App = {
            state: { scale: 1 },

            init() {
                // Event Listeners
                ['inp-institute', 'inp-exam', 'inp-total', 'inp-cols', 'inp-opts', 'inp-roll'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.render());
                });

                document.getElementById('inp-logo').addEventListener('change', (e) => this.handleLogo(e));
                window.addEventListener('resize', () => this.fitPaper());
                
                // Init Calls
                this.render();
                // Delay fitPaper to allow DOM to settle
                setTimeout(() => this.fitPaper(), 100);
            },

            // --- RENDER ENGINE ---
            render() {
                // 1. Text
                document.getElementById('out-institute').innerText = document.getElementById('inp-institute').value || "INSTITUTE";
                document.getElementById('out-exam').innerText = document.getElementById('inp-exam').value || "EXAM";

                // 2. Roll Number
                const rollDigits = parseInt(document.getElementById('inp-roll').value);
                const rollGrid = document.getElementById('roll-grid');
                rollGrid.innerHTML = '';
                for(let i=0; i<rollDigits; i++) {
                    const col = document.createElement('div');
                    col.className = 'flex flex-col items-center gap-[1px]';
                    col.style.width = '14px';
                    // Write box
                    col.innerHTML = `<div class="write-box"></div>`;
                    // Bubbles 0-9
                    for(let d=0; d<=9; d++) {
                        col.innerHTML += `<div class="bubble text-[6px] w-[11px] h-[11px]">${d}</div>`;
                    }
                    rollGrid.appendChild(col);
                }

                // 3. Questions Grid
                const total = parseInt(document.getElementById('inp-total').value);
                const cols = parseInt(document.getElementById('inp-cols').value);
                const opts = parseInt(document.getElementById('inp-opts').value);
                const qContainer = document.getElementById('q-grid');
                
                qContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                qContainer.innerHTML = '';

                const perCol = Math.ceil(total / cols);
                const letters = ['A','B','C','D','E'];

                for(let c=0; c<cols; c++) {
                    const colDiv = document.createElement('div');
                    if(c < cols-1) {
                        colDiv.style.borderRight = '1px dashed #ddd';
                        colDiv.style.paddingRight = '8px';
                    }
                    
                    for(let r=0; r<perCol; r++) {
                        const qNum = (c * perCol) + r + 1;
                        if(qNum > total) break;

                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between mb-1';
                        
                        let bHtml = '';
                        for(let o=0; o<opts; o++) {
                            bHtml += `<div class="bubble">${letters[o]}</div>`;
                        }

                        row.innerHTML = `<span class="text-[9px] font-bold w-5 text-right mr-1">${qNum}</span>
                                         <div class="flex gap-1">${bHtml}</div>`;
                        
                        if(r>0 && r%5===0) row.style.marginTop = '6px'; // Visual break
                        colDiv.appendChild(row);
                    }
                    qContainer.appendChild(colDiv);
                }

                // 4. Timing Track
                const track = document.getElementById('track-container');
                track.innerHTML = '';
                for(let i=0; i<40; i++) track.innerHTML += `<div class="track-mark"></div>`;

                // 5. Codes
                document.getElementById('qr-code').innerHTML = '';
                new QRCode(document.getElementById("qr-code"), {
                    text: "OMR-" + Date.now(),
                    width: 50, height: 50
                });
                JsBarcode("#barcode", "BATCH-" + new Date().getFullYear(), {
                    format: "CODE128", height: 20, displayValue: false, margin: 0
                });
            },

            // --- MOBILE SCALING ENGINE ---
            fitPaper() {
                const viewport = document.getElementById('sheet-viewport');
                const container = document.getElementById('scroll-container');
                
                // Get available width (minus padding)
                const availW = container.clientWidth - 20; 
                const sheetW = 794; // 210mm in px at roughly 96dpi logic
                
                let scale = availW / sheetW;
                if(scale > 1.2) scale = 1.2; // Max zoom cap
                
                this.state.scale = scale;
                viewport.style.transform = `scale(${scale})`;
                // Adjust margin bottom to prevent large empty space due to scaling
                viewport.style.marginBottom = `-${(1-scale)*100}%`;
                viewport.style.marginRight = `-${(1-scale)*100}%`; 
                
                document.getElementById('scale-indicator').innerText = Math.round(scale*100) + '%';
            },

            handleLogo(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (res) => {
                        const img = document.getElementById('img-logo-preview');
                        img.src = res.target.result;
                        img.classList.remove('hidden');
                        document.getElementById('logo-placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }
        };

        // --- MOBILE TAB LOGIC ---
        function switchTab(tab) {
            const configPanel = document.getElementById('panel-config');
            const previewPanel = document.getElementById('panel-preview');
            const tabConfig = document.getElementById('tab-config');
            const tabPreview = document.getElementById('tab-preview');

            if(tab === 'config') {
                configPanel.classList.remove('hidden');
                previewPanel.classList.add('hidden');
                previewPanel.classList.remove('flex');
                tabConfig.classList.add('active');
                tabPreview.classList.remove('active');
            } else {
                configPanel.classList.add('hidden');
                previewPanel.classList.remove('hidden');
                previewPanel.classList.add('flex');
                tabConfig.classList.remove('active');
                tabPreview.classList.add('active');
                App.fitPaper(); // Recalculate size when showing
            }
        }

        // --- PDF DOWNLOAD ---
        function downloadPDF() {
            const btn = document.getElementById('btn-dl');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> GENERATING...';
            btn.disabled = true;

            const element = document.getElementById('omr-content');
            // Clone the element to render it clean (without scaling transforms)
            const opt = {
                margin: 0,
                filename: `OMR_Sheet.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Temporarily reset transform for the capture
            const vp = document.getElementById('sheet-viewport');
            const oldTrans = vp.style.transform;
            vp.style.transform = 'scale(1)';

            html2pdf().set(opt).from(element).save().then(() => {
                vp.style.transform = oldTrans;
                btn.innerHTML = oldText;
                btn.disabled = false;
            });
        }

        // Boot
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
