<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ID Card System</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* === GLOBAL RESET === */
    * { box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    body { margin: 0; padding: 0; background-color: #e8ecf1; font-family: 'Segoe UI', sans-serif; }

    /* === UI CONTAINER === */
    #app-container {
        width: 100%; max-width: 1200px; margin: 0 auto; padding: 40px 20px;
        display: flex; flex-direction: column; align-items: center;
    }
    
    h2 {
        color: #1a2a3a; text-align: center; font-weight: 900; 
        font-family: 'Montserrat', sans-serif; font-size: 32px;
        text-transform: uppercase; margin-bottom: 5px;
    }
    .desc { color: #666; font-weight: 600; margin-bottom: 30px; }

    /* === INPUT CONTROLS === */
    .controls {
        background: white; padding: 30px; border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 400px;
        margin-bottom: 40px;
    }
    .input-group { position: relative; width: 100%; }
    .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #002347; }
    .secure-input {
        width: 100%; padding: 15px 15px 15px 45px; border: 1px solid #ddd;
        border-radius: 10px; font-size: 14px; font-weight: 600; font-family: 'Montserrat', sans-serif;
        background: #f9f9f9; outline: none; transition: 0.3s;
    }
    .secure-input:focus { border-color: #002347; background: #fff; }

    .btn-main {
        background: #002347; color: white; border: none; padding: 15px;
        border-radius: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer;
        width: 100%; transition: 0.3s; letter-spacing: 1px;
    }
    .btn-main:hover { background: #003366; transform: translateY(-2px); }

    #status-msg { font-size: 13px; font-weight: 700; color: #555; text-align: center; min-height: 20px; }

    /* === PREVIEW GRID === */
    #grid-area { display: flex; flex-direction: column; gap: 40px; align-items: center; width: 100%; }
    
    .member-row {
        background: white; padding: 40px; border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        display: flex; gap: 50px; flex-wrap: wrap; justify-content: center;
        width: 100%; max-width: 900px;
    }

    .preview-col { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .preview-lbl { font-size: 12px; font-weight: 800; text-transform: uppercase; color: #888; letter-spacing: 1px; }

    /* === ACTIONS === */
    .action-box { display: flex; flex-direction: column; gap: 10px; justify-content: center; }
    .act-btn {
        padding: 15px 25px; border: none; border-radius: 12px;
        font-weight: 800; color: white; cursor: pointer; display: flex; align-items: center; gap: 10px;
        font-size: 14px; transition: 0.2s; min-width: 160px;
    }
    .btn-print { background: #FF9933; box-shadow: 0 4px 10px rgba(255, 153, 51, 0.3); }
    .btn-print:hover { background: #e68a00; }
    .btn-dl { background: #002347; box-shadow: 0 4px 10px rgba(0, 35, 71, 0.3); }
    .btn-dl:hover { background: #00152e; }

    /* ========================================= */
    /* === ID CARD CORE CSS (Used in Print) === */
    /* ========================================= */
    
    /* Variables for Exact Metric Dimensions */
    :root {
        --card-w: 54mm;
        --card-h: 85.6mm;
        --p-color: #002347; /* Primary Blue */
        --s-color: #FF9933; /* Secondary Orange */
    }

    /* The Wrapper for Screen Preview */
    .card-wrap {
        width: var(--card-w); height: var(--card-h);
        position: relative; 
        border-radius: 3mm;
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        transition: transform 0.3s;
    }
    .card-wrap:hover { transform: scale(1.05); z-index: 5; }

    /* The Actual Card Content */
    .id-card {
        width: 100%; height: 100%;
        background: white;
        position: relative; overflow: hidden;
        border-radius: 3mm;
        border: 1px solid #ddd;
        font-family: 'Montserrat', sans-serif;
        display: flex; flex-direction: column;
    }

    /* --- FRONT SIDE --- */
    .f-header {
        height: 16mm; background: var(--p-color);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 2mm 0 3mm; position: relative;
        clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%);
    }
    .f-logo { width: 8mm; height: auto; margin-right: 1.5mm; }
    .f-title { color: white; font-family: 'Oswald', sans-serif; font-size: 7pt; font-weight: 700; line-height: 1.1; text-transform: uppercase; }
    .f-qr { width: 9mm; height: 9mm; background: white; padding: 1px; border-radius: 2px; display: flex; align-items: center; justify-content: center; margin-bottom: 2mm; margin-right: 1mm; }
    .f-qr img { width: 100%; height: 100%; }

    .f-body {
        flex: 1; display: flex; flex-direction: column; align-items: center;
        background-image: radial-gradient(#ddd 1px, transparent 1px);
        background-size: 5mm 5mm;
        padding-top: 2mm; position: relative;
    }

    /* Photo Logic */
    .f-photo-box {
        width: 22mm; height: 26mm;
        background: white; border: 1px solid #ccc;
        border-radius: 3px; padding: 1px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        z-index: 10; margin-bottom: 1.5mm;
        position: relative;
    }
    .f-photo-img { width: 100%; height: 100%; object-fit: cover; border-radius: 2px; display: block; }

    .f-name { color: var(--p-color); font-size: 9pt; font-weight: 900; text-transform: uppercase; text-align: center; width: 95%; line-height: 1; margin-bottom: 1px; }
    .f-role { background: var(--s-color); color: white; font-size: 5pt; font-weight: 800; padding: 1px 6px; text-transform: uppercase; margin-bottom: 2mm; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0% 100%); }

    .f-table { width: 88%; margin-bottom: auto; }
    .f-row { display: flex; border-bottom: 0.5px solid #eee; padding: 1px 0; }
    .f-lbl { width: 40%; font-size: 4.5pt; font-weight: 700; color: #666; text-transform: uppercase; }
    .f-val { width: 60%; font-size: 5.5pt; font-weight: 800; color: #000; text-align: right; }

    .f-barcode { width: 90%; height: 7mm; display: flex; justify-content: center; position: absolute; bottom: 6mm; }
    .f-barcode svg { width: 100%; height: 100%; }

    /* --- BACK SIDE (Fixed Layout) --- */
    .b-container { width: 100%; height: 100%; display: flex; flex-direction: column; background: white; position: relative; }
    
    .b-header { height: 7mm; background: var(--p-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 6.5pt; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1.5px solid var(--s-color); }
    
    .b-body { padding: 2mm; display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; }
    
    .b-logo { width: 14mm; opacity: 1; margin-bottom: 1mm; }
    .b-org { font-size: 7.5pt; font-weight: 900; color: var(--p-color); text-transform: uppercase; text-align: center; margin-bottom: 2mm; width: 100%; line-height: 1; }
    
    .b-qr-label { font-size: 4.5pt; font-weight: 800; color: var(--s-color); text-transform: uppercase; margin-bottom: 0.5mm; }
    .b-qr-box { width: 13mm; height: 13mm; border: 0.5px solid #ccc; padding: 1px; margin-bottom: 2mm; }
    .b-qr-box img { width: 100%; height: 100%; }

    .b-info { width: 100%; margin-bottom: 1mm; }
    .b-info-row { display: flex; gap: 2mm; align-items: flex-start; margin-bottom: 1mm; }
    .b-icon { color: var(--s-color); width: 3mm; font-size: 5pt; text-align: center; }
    .b-text { font-size: 4.5pt; color: #333; font-weight: 600; text-align: left; line-height: 1.1; flex: 1; }

    /* Absolute Positioning for Bottom Elements to ensure visibility */
    .b-auth-area { 
        position: absolute; bottom: 12mm; right: 2mm; 
        display: flex; flex-direction: column; align-items: center; 
        width: 20mm; z-index: 10;
    }
    .b-stamp { width: 15mm; opacity: 0.8; mix-blend-mode: multiply; transform: rotate(-10deg); margin-bottom: -1mm; }
    .b-sign-text { font-size: 3.5pt; font-weight: 800; color: var(--p-color); border-top: 1px solid var(--p-color); width: 100%; text-align: center; padding-top: 1px; text-transform: uppercase; }

    .b-terms { 
        position: absolute; bottom: 6mm; left: 2mm; width: 65%;
    }
    .b-terms-head { font-size: 3.5pt; font-weight: 800; color: var(--p-color); text-transform: uppercase; margin-bottom: 0.5px; }
    .b-terms-body { font-size: 3pt; color: #666; line-height: 1.1; }

    /* --- FOOTER (BOTH) --- */
    .c-footer {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 4.5mm;
        display: flex; align-items: center; justify-content: center;
        font-size: 4pt; font-weight: 700; text-transform: uppercase; color: white;
        z-index: 20;
    }
    .f-footer-bg { background: var(--p-color); color: var(--s-color); border-top: 1px solid var(--s-color); }
    .b-footer-bg { background: #138808; color: white; }

</style>
</head>
<body>

<div id="app-container">
    <h2>Official Card Portal</h2>
    <p class="desc">Database Verification System</p>

    <div class="controls">
        <div class="input-group">
            <i class="fa-solid fa-user-tag"></i>
            <input type="text" id="inp-id" class="secure-input" placeholder="Enter Member ID (e.g. 101)">
        </div>
        <div class="input-group">
            <i class="fa-solid fa-phone"></i>
            <input type="text" id="inp-phone" class="secure-input" placeholder="Registered Phone">
        </div>
        <button class="btn-main" onclick="startVerification()">
            <i class="fa-solid fa-fingerprint"></i> Verify & Generate
        </button>
        <div id="status-msg">Waiting for input...</div>
    </div>

    <div id="grid-area"></div>
</div>

<script>
    // --- SETTINGS ---
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1p1ynKWyRErPwczTcMkffZfQ7dhOiV9buv_gIVRK3uh0/export?format=csv&gid=85144492";
    
    const ORG = {
        name: "Tiranga Yuva Samiti",
        logo: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCaJCRPLvQgi9REoAvb9b4H4Vvh6RhAmMRGwGEolXIqS2nxxCa9-jS7qexF2JL5puwPOEk-2q7ubDKeL-m-BM0_7_uHrI5EnBXue7deGtgta4UyCDnI43AkB1KBN8PV4G00fg1vW2La338AyzZkHvXpzt49papqeYLt9NDXMcTnvsceg/s1600/TYS-White.png",
        stamp: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEif3QsddJJfS7s0DWat3m-JGugl9Jf3PHlxuPenO9wCWmjqiqV2UZ2IBMA_0b2ID8Uk1Ukwozo206pIjMGCEm5rK6e24u33ZDaSUUvnVzfsMQX6aY4BoleEeCGB3PMBfh4VER_I5Qsac0CHXkwtvVu5kuefZWrr9qr5MEOPyL8_tpkKow/s1600/Naveen%20Stamp.jpg",
        web: "www.tirangayuvasamiti.org",
        donate: "https://www.tirangayuvasamiti.org/donate/",
        contact: {
            addr: "VPO Khanda 9R, Tehsil Kharkhoda, Sonipat, Haryana – 131402",
            ph: "+91 90535 75169",
            email: "info@tirangayuvasamiti.org"
        }
    };

    // --- STATE ---
    let DB = [];
    let IMAGES = { logo: null, stamp: null };

    // --- INIT ---
    window.onload = async () => {
        document.getElementById('status-msg').innerHTML = '<i class="fa fa-spinner fa-spin"></i> Loading Database...';
        await loadImages();
        await loadData();
    };

    // 1. Convert Images to Base64 (Crucial for Print)
    async function loadImages() {
        const toBase64 = (url) => fetch(url).then(res => res.blob()).then(blob => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }).catch(() => url); // Fallback to URL if CORS fails

        IMAGES.logo = await toBase64(ORG.logo);
        IMAGES.stamp = await toBase64(ORG.stamp);
    }

    // 2. Load Excel Data
    async function loadData() {
        try {
            const res = await fetch(SHEET_URL + "&t=" + Date.now());
            const ab = await res.arrayBuffer();
            const wb = XLSX.read(ab, {type:"array", cellDates:true});
            DB = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            document.getElementById('status-msg').innerHTML = '<span style="color:green">✅ System Online</span>';
        } catch(e) {
            document.getElementById('status-msg').innerHTML = '<span style="color:red">❌ Connection Failed</span>';
        }
    }

    // 3. Verify User
    function startVerification() {
        const uid = document.getElementById('inp-id').value.trim().toLowerCase();
        const ph = document.getElementById('inp-phone').value.trim().toLowerCase();
        const grid = document.getElementById('grid-area');
        
        if(!uid || !ph) { alert("Please enter both ID and Phone"); return; }

        const found = DB.filter(m => {
            const mId = String(m.id||'').toLowerCase().trim();
            const mPh = String(m.phone||'').toLowerCase().trim();
            return mId.includes(uid) && mPh.includes(ph);
        });

        if(found.length === 0) {
            alert("No matching member found.");
            grid.innerHTML = "";
            return;
        }

        renderCard(found[0]);
    }

    // 4. Render Card HTML
    function renderCard(data) {
        const grid = document.getElementById('grid-area');
        
        // Data prep
        const name = (data.firstname + ' ' + (data.lastname||'')).trim().toUpperCase();
        const father = (data.father_name || '___________').toUpperCase();
        const id = data.id || '000';
        const role = (data.membership || 'MEMBER').toUpperCase();
        const phone = data.phone || '___________';
        const rawDate = data.joined;
        let dateStr = "___________";
        
        if(rawDate) {
            const d = new Date(rawDate);
            if(!isNaN(d)) dateStr = `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
        }

        // Slug for QR
        const slug = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        const profileUrl = `${ORG.web}/tiranga-yuva-members/${slug}/`;

        // IDs
        const fId = "f-card", bId = "b-card";
        const q1 = "q-head", q2 = "q-body", bar = "bar-main";

        // Template
        const html = `
        <div class="member-row">
            <div class="preview-col">
                <span class="preview-lbl">Front Side</span>
                <div class="card-wrap" id="${fId}">
                    <div class="id-card">
                        <div class="f-header">
                            <div style="display:flex; align-items:center;">
                                <img src="${IMAGES.logo}" class="f-logo">
                                <div class="f-title">Tiranga<br>Yuva<br>Samiti</div>
                            </div>
                            <div id="${q1}" class="f-qr"></div>
                        </div>
                        <div class="f-body">
                            <div class="f-photo-box">
                                <img src="${data.photo_url}" class="f-photo-img" crossorigin="anonymous">
                            </div>
                            <div class="f-name">${name}</div>
                            <div class="f-role">${role}</div>
                            
                            <div class="f-table">
                                <div class="f-row"><div class="f-lbl">Father's Name</div><div class="f-val">${father}</div></div>
                                <div class="f-row"><div class="f-lbl">Membership ID</div><div class="f-val">TYS-${id}</div></div>
                                <div class="f-row"><div class="f-lbl">Contact No.</div><div class="f-val">${phone}</div></div>
                                <div class="f-row"><div class="f-lbl">Issue Date</div><div class="f-val">${dateStr}</div></div>
                            </div>
                            <div class="f-barcode"><svg id="${bar}"></svg></div>
                        </div>
                        <div class="c-footer f-footer-bg">Tiranga Yuva Samiti</div>
                    </div>
                </div>
            </div>

            <div class="preview-col">
                <span class="preview-lbl">Back Side</span>
                <div class="card-wrap" id="${bId}">
                    <div class="id-card">
                        <div class="b-container">
                            <div class="b-header">Official Identification</div>
                            <div class="b-body">
                                <img src="${IMAGES.logo}" class="b-logo">
                                <div class="b-org">${ORG.name}</div>
                                
                                <div class="b-qr-label">SCAN TO VERIFY</div>
                                <div id="${q2}" class="b-qr-box"></div>

                                <div class="b-info">
                                    <div class="b-info-row">
                                        <div class="b-icon"><i class="fa-solid fa-location-dot"></i></div>
                                        <div class="b-text">${ORG.contact.addr}</div>
                                    </div>
                                    <div class="b-info-row">
                                        <div class="b-icon"><i class="fa-solid fa-phone"></i></div>
                                        <div class="b-text">${ORG.contact.ph}</div>
                                    </div>
                                    <div class="b-info-row">
                                        <div class="b-icon"><i class="fa-solid fa-envelope"></i></div>
                                        <div class="b-text">${ORG.contact.email}</div>
                                    </div>
                                </div>

                                <div class="b-auth-area">
                                    <img src="${IMAGES.stamp}" class="b-stamp">
                                    <div class="b-sign-text">Auth. Signatory</div>
                                </div>

                                <div class="b-terms">
                                    <div class="b-terms-head">Terms & Conditions:</div>
                                    <div class="b-terms-body">
                                        1. Card is non-transferable property.<br>
                                        2. If found, return to given address.
                                    </div>
                                </div>
                            </div>
                            <div class="c-footer b-footer-bg">Together We Serve • Jai Hind</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-box">
                <button class="act-btn btn-print" onclick="printCard('${fId}','${bId}')">
                    <i class="fa-solid fa-print"></i> Print Card
                </button>
                <button class="act-btn btn-dl" onclick="downloadImage('${fId}','${bId}', '${name}')">
                    <i class="fa-solid fa-download"></i> Download
                </button>
            </div>
        </div>
        `;
        
        grid.innerHTML = html;

        // Generate Codes after DOM update
        setTimeout(() => {
            // Donate QR
            new QRCode(document.getElementById(q1), { text: ORG.donate, width: 64, height: 64, correctLevel: QRCode.CorrectLevel.L });
            // Profile QR
            new QRCode(document.getElementById(q2), { text: profileUrl, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
            // Barcode
            JsBarcode("#"+bar, "TYS-"+id, { format: "CODE128", displayValue: false, height: 30, margin: 0, width: 1.5, background: "transparent" });
            
            // Fix canvas to images for print
            [q1, q2].forEach(id => {
                const el = document.getElementById(id);
                const c = el.querySelector('canvas');
                if(c) {
                    const i = document.createElement('img');
                    i.src = c.toDataURL();
                    el.innerHTML = ''; el.appendChild(i);
                }
            });
        }, 100);
    }

    // 5. PRINT FUNCTION (ROBUST)
    function printCard(fid, bid) {
        const fHtml = document.getElementById(fid).innerHTML;
        const bHtml = document.getElementById(bid).innerHTML;
        
        // We create an iframe to print 100% reliably without CSS conflicts
        const iframe = document.createElement('iframe');
        iframe.style.position = 'absolute';
        iframe.style.width = '0px'; iframe.style.height = '0px';
        document.body.appendChild(iframe);
        
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`
            <html><head><title>Print ID</title>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
                @page { margin: 0; size: auto; } /* Let printer handle paper size, we center content */
                body { margin: 0; padding: 20px; background: white; display: flex; flex-direction: row; gap: 10px; justify-content: center; }
                
                /* EXACT COPY OF CSS WITH PRINT ADJUSTMENTS */
                * { box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                
                .id-card-print {
                    width: 54mm; height: 85.6mm;
                    position: relative; overflow: hidden;
                    border: 1px solid #ddd; border-radius: 3mm;
                    background: white; page-break-inside: avoid;
                    display: flex; flex-direction: column;
                }

                /* Reuse Core Styles */
                :root { --p-color: #002347; --s-color: #FF9933; }
                
                /* Front */
                .f-header { height: 16mm; background: var(--p-color); display: flex; align-items: center; justify-content: space-between; padding: 0 2mm 0 3mm; clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); }
                .f-logo { width: 8mm; height: auto; margin-right: 1.5mm; }
                .f-title { color: white; font-family: 'Oswald', sans-serif; font-size: 7pt; font-weight: 700; line-height: 1.1; text-transform: uppercase; }
                .f-qr { width: 9mm; height: 9mm; background: white; padding: 1px; border-radius: 2px; display: flex; align-items: center; justify-content: center; margin-bottom: 2mm; margin-right: 1mm; }
                .f-qr img { width: 100%; height: 100%; }
                .f-body { flex: 1; display: flex; flex-direction: column; align-items: center; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 5mm 5mm; padding-top: 2mm; position: relative; }
                .f-photo-box { width: 22mm; height: 26mm; background: white; border: 1px solid #ccc; border-radius: 3px; padding: 1px; z-index: 10; margin-bottom: 1.5mm; }
                .f-photo-img { width: 100%; height: 100%; object-fit: cover; border-radius: 2px; display: block; }
                .f-name { color: var(--p-color); font-family: 'Montserrat', sans-serif; font-size: 9pt; font-weight: 900; text-transform: uppercase; text-align: center; width: 95%; line-height: 1; margin-bottom: 1px; }
                .f-role { background: var(--s-color); color: white; font-family: 'Montserrat', sans-serif; font-size: 5pt; font-weight: 800; padding: 1px 6px; text-transform: uppercase; margin-bottom: 2mm; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0% 100%); }
                .f-table { width: 88%; margin-bottom: auto; }
                .f-row { display: flex; border-bottom: 0.5px solid #eee; padding: 1px 0; }
                .f-lbl { width: 40%; font-family: 'Montserrat', sans-serif; font-size: 4.5pt; font-weight: 700; color: #666; text-transform: uppercase; }
                .f-val { width: 60%; font-family: 'Montserrat', sans-serif; font-size: 5.5pt; font-weight: 800; color: #000; text-align: right; }
                .f-barcode { width: 90%; height: 7mm; display: flex; justify-content: center; position: absolute; bottom: 6mm; }
                .f-barcode svg { width: 100%; height: 100%; }

                /* Back */
                .b-container { width: 100%; height: 100%; display: flex; flex-direction: column; background: white; position: relative; }
                .b-header { height: 7mm; background: var(--p-color); display: flex; align-items: center; justify-content: center; color: white; font-family: 'Montserrat', sans-serif; font-size: 6.5pt; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1.5px solid var(--s-color); }
                .b-body { padding: 2mm; display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; }
                .b-logo { width: 14mm; margin-bottom: 1mm; }
                .b-org { font-size: 7.5pt; font-weight: 900; color: var(--p-color); font-family: 'Montserrat', sans-serif; text-transform: uppercase; text-align: center; margin-bottom: 2mm; width: 100%; line-height: 1; }
                .b-qr-label { font-size: 4.5pt; font-weight: 800; color: var(--s-color); font-family: 'Montserrat', sans-serif; text-transform: uppercase; margin-bottom: 0.5mm; }
                .b-qr-box { width: 13mm; height: 13mm; border: 0.5px solid #ccc; padding: 1px; margin-bottom: 2mm; }
                .b-qr-box img { width: 100%; height: 100%; }
                .b-info { width: 100%; margin-bottom: 1mm; }
                .b-info-row { display: flex; gap: 2mm; align-items: flex-start; margin-bottom: 1mm; }
                .b-icon { color: var(--s-color); width: 3mm; font-size: 5pt; text-align: center; }
                .b-text { font-size: 4.5pt; color: #333; font-weight: 600; font-family: 'Montserrat', sans-serif; text-align: left; line-height: 1.1; flex: 1; }
                
                .b-auth-area { position: absolute; bottom: 12mm; right: 2mm; display: flex; flex-direction: column; align-items: center; width: 20mm; z-index: 10; }
                .b-stamp { width: 15mm; opacity: 0.8; mix-blend-mode: multiply; transform: rotate(-10deg); margin-bottom: -1mm; }
                .b-sign-text { font-size: 3.5pt; font-weight: 800; color: var(--p-color); border-top: 1px solid var(--p-color); width: 100%; text-align: center; padding-top: 1px; text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
                
                .b-terms { position: absolute; bottom: 6mm; left: 2mm; width: 65%; }
                .b-terms-head { font-size: 3.5pt; font-weight: 800; color: var(--p-color); font-family: 'Montserrat', sans-serif; text-transform: uppercase; margin-bottom: 0.5px; }
                .b-terms-body { font-size: 3pt; color: #666; line-height: 1.1; font-family: 'Montserrat', sans-serif; }

                .c-footer { position: absolute; bottom: 0; left: 0; width: 100%; height: 4.5mm; display: flex; align-items: center; justify-content: center; font-size: 4pt; font-weight: 700; text-transform: uppercase; color: white; z-index: 20; font-family: 'Montserrat', sans-serif; }
                .f-footer-bg { background: var(--p-color); color: var(--s-color); border-top: 1px solid var(--s-color); }
                .b-footer-bg { background: #138808; color: white; }
            </style>
            </head><body>
        `);
        
        doc.write('<div class="id-card-print">' + fHtml + '</div>');
        doc.write('<div class="id-card-print">' + bHtml + '</div>');
        doc.write('</body></html>');
        doc.close();

        // Wait for images to load inside iframe before printing
        iframe.contentWindow.onload = () => {
            setTimeout(() => {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                document.body.removeChild(iframe);
            }, 500);
        };
    }

    // 6. DOWNLOAD FUNCTION
    function downloadImage(fid, bid, filename) {
        // Clone to a temp container to capture side-by-side
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.gap = '20px';
        container.style.padding = '20px';
        container.style.background = 'white';
        container.style.position = 'absolute'; 
        container.style.top = '-9999px';
        
        // Clone content
        const f = document.getElementById(fid).cloneNode(true);
        const b = document.getElementById(bid).cloneNode(true);
        f.style.transform = 'none'; b.style.transform = 'none';
        f.style.boxShadow = 'none'; b.style.boxShadow = 'none';
        
        container.appendChild(f);
        container.appendChild(b);
        document.body.appendChild(container);

        html2canvas(container, { scale: 3, useCORS: true, backgroundColor: "#ffffff" })
        .then(canvas => {
            const link = document.createElement('a');
            link.download = `TYS-ID-${filename}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            document.body.removeChild(container);
        });
    }

</script>
</body>
</html>
