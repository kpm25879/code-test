<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
    if (!document.querySelector('meta[name="viewport"]')) {
        const meta = document.createElement('meta');
        meta.name = "viewport";
        meta.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no";
        document.getElementsByTagName('head')[0].appendChild(meta);
    }
</script>

<style>
    /* === GLOBAL SETUP === */
    html, body { 
        margin: 0; padding: 0; width: 100%; overflow-x: hidden; 
        background-color: #f4f7f6; 
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

    #tys-wrapper {
        font-family: 'Segoe UI', sans-serif;
        background: #f4f7f6;
        min-height: 100vh;
        color: #333;
        box-sizing: border-box;
    }
    #tys-wrapper * { box-sizing: border-box; }

    /* === UI CONTAINER === */
    #tys-wrapper .app-box {
        width: 100%; max-width: 1200px; margin: 0 auto;
        padding: 40px 20px;
        display: flex; flex-direction: column; align-items: center;
    }

    #tys-wrapper h2 {
        color: #2c3e50; margin: 0 0 10px 0; text-align: center;
        font-weight: 800; font-family: 'Montserrat', sans-serif; font-size: 32px;
        text-transform: uppercase; letter-spacing: -0.5px;
    }

    #tys-wrapper p.desc { color: #7f8c8d; margin-bottom: 30px; text-align: center; font-size: 16px; font-weight: 500; }

    /* === CONTROLS === */
    #tys-wrapper .controls {
        background: white;
        padding: 30px; 
        border-radius: 16px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        display: flex; flex-direction: column; gap: 20px; 
        align-items: center;
        border-top: 6px solid #FF9933; 
        width: 100%; max-width: 500px;
        margin-bottom: 50px;
    }

    #tys-wrapper .input-group { width: 100%; position: relative; }
    #tys-wrapper .input-icon {
        position: absolute; left: 18px; top: 50%; transform: translateY(-50%);
        color: #FF9933; font-size: 18px; z-index: 2;
    }

    #tys-wrapper .secure-input {
        width: 100%; padding: 16px 16px 16px 50px; 
        border: 2px solid #eee; border-radius: 8px;
        font-size: 16px; color: #333; background: #fdfdfd; 
        transition: all 0.3s ease;
        font-family: 'Montserrat', sans-serif; font-weight: 600;
    }
    #tys-wrapper .secure-input:focus { outline: none; border-color: #FF9933; background: white; box-shadow: 0 4px 12px rgba(255, 153, 51, 0.1); }

    #tys-wrapper .btn-verify {
        background: linear-gradient(135deg, #FF9933 0%, #FF6600 100%);
        color: white; border: none; padding: 16px;
        border-radius: 8px; cursor: pointer; font-weight: 800; text-transform: uppercase;
        font-size: 16px; width: 100%; transition: all 0.3s ease; letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
    }
    #tys-wrapper .btn-verify:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 102, 0, 0.4); }

    #tys-wrapper #status-msg { 
        font-weight: 700; font-size: 14px; color: #95a5a6; margin-top: 5px;
        min-height: 20px; text-align: center; width: 100%;
    }

    /* === GRID === */
    #tys-wrapper #grid-area {
        display: flex; flex-direction: column; gap: 40px; align-items: center; width: 100%;
    }

    .member-row {
        display: flex; gap: 50px; align-items: center; justify-content: center;
        background: white; padding: 40px; border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.05);
        animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        flex-wrap: wrap; width: 100%;
    }
    @keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }

    .preview-col { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .preview-label { font-size: 12px; color: #aaa; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; }

    .print-btn {
        background: linear-gradient(135deg, #138808 0%, #006400 100%);
        color: white; border: none; padding: 20px 30px;
        border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: 800;
        display: flex; flex-direction: column; align-items: center; gap: 10px;
        box-shadow: 0 10px 25px rgba(19, 136, 8, 0.3); transition: all 0.3s;
        min-width: 140px;
    }
    .print-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 15px 35px rgba(19, 136, 8, 0.4); }

    /* === ID CARD CONTAINER (54mm x 85.6mm) === */
    .id-card-wrapper { 
        width: 54mm; height: 85.6mm; 
        position: relative; 
        background: white;
        /* THE SHADOW FOR DISPLAY ONLY */
        box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
        border-radius: 8px; /* External radius */
        transition: transform 0.3s ease;
    }
    .id-card-wrapper:hover { transform: scale(1.02); }

    /* === INTERNAL CARD STRUCTURE === */
    .id-card { 
        width: 54mm; height: 85.6mm; 
        background: #fff; 
        position: relative; 
        overflow: hidden; 
        font-family: 'Montserrat', sans-serif; 
        color: #333; 
        display: flex; flex-direction: column;
        /* BOUNDARY OUTLINE */
        border: 1px solid #dcdcdc; 
        border-radius: 8px; /* Card Rounded Corners */
    }

    /* === FRONT SIDE DESIGN === */
    .v-header {
        height: 18%;
        /* 3D HEADER GRADIENT */
        background: linear-gradient(180deg, #FF9933 0%, #FF8800 80%, #E67300 100%);
        width: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        position: relative; z-index: 5;
        box-shadow: 0 4px 6px rgba(0,0,0,0.15); /* 3D Drop Shadow */
        padding-top: 1mm;
    }
    .v-header-logo { width: 8mm; height: auto; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); margin-bottom: 1px; }
    .v-org-name { 
        font-size: 8pt; font-weight: 900; color: white; 
        text-transform: uppercase; margin: 0; line-height: 1; 
        text-align: center; width: 92%; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .v-body {
        flex: 1; position: relative;
        display: flex; flex-direction: column; align-items: center;
        padding-top: 4mm;
        /* SUBTLE MESH BACKGROUND */
        background-image: radial-gradient(#eee 1px, transparent 1px);
        background-size: 5mm 5mm;
    }

    /* Side Accents */
    .v-body::before { content:''; position: absolute; left: 0; top:0; bottom:0; width: 1mm; background: linear-gradient(to bottom, #FF9933, #ffffff, #138808); }
    .v-body::after { content:''; position: absolute; right: 0; top:0; bottom:0; width: 1mm; background: linear-gradient(to bottom, #FF9933, #ffffff, #138808); }

    .v-photo-frame {
        width: 22mm; height: 26mm;
        background: white;
        border-radius: 4px;
        position: relative; z-index: 2; margin-bottom: 2mm;
        /* 3D BORDER EFFECT */
        box-shadow: 0 0 0 2px white, 0 0 0 3px #FF9933, 0 5px 10px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .v-user-photo { width: 100%; height: 100%; object-fit: cover; }
    
    /* NAME & ROLE */
    .v-name-block { text-align: center; margin-bottom: 3mm; z-index: 2; width: 85%; }
    .v-name-text { 
        font-size: 10pt; font-weight: 800; color: #000080; 
        text-transform: uppercase; line-height: 1.1; margin-bottom: 1px;
    }
    .v-role-badge { 
        background: #000080; color: white; 
        font-size: 4.5pt; font-weight: 700; 
        padding: 2px 8px; border-radius: 50px; 
        display: inline-block; text-transform: uppercase; letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* GLASSMORPHISM DATA TABLE */
    .v-details-table { 
        width: 86%; z-index: 2; margin-bottom: auto; 
        background: rgba(255,255,255,0.85); 
        backdrop-filter: blur(2px);
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 6px; padding: 3px 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .v-row { display: flex; align-items: center; margin-bottom: 2px; border-bottom: 1px solid rgba(0,0,0,0.06); padding: 1.5px 0; }
    .v-row:last-child { border: none; }
    /* FULL WORD LABELS */
    .v-lbl { 
        width: 45%; font-weight: 700; color: #666; 
        font-size: 5pt; text-transform: uppercase; letter-spacing: 0.2px; 
    }
    .v-val { 
        width: 55%; font-weight: 700; color: #000; text-align: right; 
        font-size: 5.5pt; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }

    .v-qr-area { margin-bottom: 3mm; z-index: 2; position: relative; }
    .v-qr-box { 
        width: 14mm; height: 14mm; 
        padding: 1px; background: white; 
        border: 1px solid #ddd; border-radius: 2px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1); 
    }
    .v-qr-box img { width: 100%; height: 100%; }

    .v-footer {
        height: 6%;
        /* 3D GREEN FOOTER */
        background: linear-gradient(180deg, #138808 0%, #0D6605 100%);
        width: 100%;
        display: flex; align-items: center; justify-content: center;
        color: white; font-size: 5pt; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
        box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        z-index: 5;
    }

    .v-stamp { position: absolute; top: 20mm; right: 6mm; width: 22mm; opacity: 0.9; mix-blend-mode: multiply; z-index: 10; transform: rotate(-20deg); pointer-events: none;}

    /* === BACK SIDE DESIGN === */
    .vb-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; }
    
    .vb-header { 
        height: 12%; 
        background: linear-gradient(180deg, #FF9933, #e68a00); 
        display: flex; align-items: center; justify-content: center; 
        color: white; font-weight: 800; font-size: 7.5pt; 
        text-transform: uppercase; letter-spacing: 0.5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2;
    }
    
    .vb-body { 
        flex: 1; display: flex; flex-direction: column; align-items: center; 
        padding: 5mm; text-align: center; position: relative; background: #fff; 
    }
    
    /* FULL LOGO */
    .vb-logo-main { 
        width: 24mm; height: auto; 
        margin-bottom: 4mm; margin-top: 3mm; 
        opacity: 1.0; /* FULL VISIBILITY */
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }
    
    .vb-text-group { z-index: 2; width: 100%; margin-top: auto; margin-bottom: auto; }
    .vb-label { font-size: 4.5pt; color: #999; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1px; }
    .vb-ngo-name { font-size: 8.5pt; font-weight: 900; color: #FF9933; text-transform: uppercase; margin-bottom: 4mm; line-height: 1.2; text-shadow: 0 1px 1px rgba(0,0,0,0.05); }
    
    .vb-contact-row { 
        display: flex; align-items: flex-start; gap: 3mm; 
        font-size: 6pt; color: #555; margin-bottom: 2.5mm; text-align: left; 
        border-bottom: 1px dotted #eee; padding-bottom: 1mm;
    }
    .vb-contact-row:last-child { border: none; }
    .vb-icon { color: #138808; width: 4mm; text-align: center; font-size: 7pt; }
    .vb-data { flex: 1; line-height: 1.3; font-weight: 600; }

    .vb-footer { height: auto; padding-bottom: 2mm; text-align: center; z-index: 2; background: white; }
    .vb-disclaimer { font-size: 4pt; color: #aaa; font-weight: 500; font-style: italic; padding: 0 4mm; margin-bottom: 2mm; line-height: 1.2; }
    .vb-strip { 
        height: 4mm; 
        background: linear-gradient(180deg, #138808, #0B5E05); 
        width: 100%; 
    }

    /* Responsive */
    @media (max-width: 768px) {
        .member-row { flex-direction: column; gap: 40px; padding: 20px; }
        .controls { width: 100%; border-radius: 0; }
        #tys-wrapper .app-box { padding: 10px 0; }
        .id-card-wrapper { transform: scale(0.9); }
    }
</style>

<div id="tys-wrapper">
    <div class="app-box">
        <h2>ID Card Verification</h2>
        <p class="desc">Secure Database Access System</p>

        <div class="controls">
            <div class="input-group">
                <i class="fa-solid fa-id-card input-icon"></i>
                <input type="text" id="inputId" class="secure-input" placeholder="Enter Member ID">
            </div>

            <div class="input-group">
                <i class="fa-solid fa-phone input-icon"></i>
                <input type="text" id="inputPhone" class="secure-input" placeholder="Enter Phone Number">
            </div>

            <button class="btn-verify" onclick="verifyAndSearch()">
                <i class="fa-solid fa-shield-halved"></i> Verify Identity
            </button>

            <div id="status-msg">System Ready. Waiting for input...</div>
        </div>

        <div id="grid-area"></div>
    </div>
</div>

<script>
    // === CONFIGURATION ===
    const EXCEL_FILE_URL = "https://docs.google.com/spreadsheets/d/1p1ynKWyRErPwczTcMkffZfQ7dhOiV9buv_gIVRK3uh0/export?format=csv&gid=85144492";

    const CONFIG = {
        ngoName: "Tiranga Yuva Samiti",
        ngoSub: "Service • Unity • Patriotism",
        logoUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCaJCRPLvQgi9REoAvb9b4H4Vvh6RhAmMRGwGEolXIqS2nxxCa9-jS7qexF2JL5puwPOEk-2q7ubDKeL-m-BM0_7_uHrI5EnBXue7deGtgta4UyCDnI43AkB1KBN8PV4G00fg1vW2La338AyzZkHvXpzt49papqeYLt9NDXMcTnvsceg/s1600/TYS-White.png",
        stampUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEif3QsddJJfS7s0DWat3m-JGugl9Jf3PHlxuPenO9wCWmjqiqV2UZ2IBMA_0b2ID8Uk1Ukwozo206pIjMGCEm5rK6e24u33ZDaSUUvnVzfsMQX6aY4BoleEeCGB3PMBfh4VER_I5Qsac0CHXkwtvVu5kuefZWrr9qr5MEOPyL8_tpkKow/s1600/Naveen%20Stamp.jpg",
        contact: {
            phone: "+91 90535 75169",
            email: "info@tirangayuvasamiti.org",
            web: "www.tirangayuvasamiti.org",
            address: "VPO Khanda 9R, Tehsil Kharkhoda, Sonipat, Haryana – 131402"
        }
    };

    let CACHED_LOGO = CONFIG.logoUrl;
    let CACHED_STAMP = CONFIG.stampUrl;
    let ALL_MEMBERS = [];

    // Preload Logic
    function preloadImage(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function() {
            var reader = new FileReader();
            reader.onloadend = function() { callback(reader.result); }
            reader.readAsDataURL(xhr.response);
        };
        xhr.onerror = function() { callback(url); };
        xhr.open('GET', url);
        xhr.responseType = 'blob';
        xhr.send();
    }
    preloadImage(CONFIG.logoUrl, (data) => CACHED_LOGO = data);
    preloadImage(CONFIG.stampUrl, (data) => CACHED_STAMP = data);

    const FIELD = {
        first: "firstname", 
        last: "lastname", 
        father: "father_name", 
        id: "id", 
        role: "membership", 
        issueDate: "joined", 
        phone: "phone",
        photo: "photo_url"
    };

    function formatDate(raw) {
        if (!raw) return '________';
        let dateObj;
        if (typeof raw === 'number') {
            dateObj = new Date(Math.round((raw - 25569) * 86400 * 1000));
        } else {
            const str = String(raw).trim();
            if(str.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = str.split('-');
                return `${parts[2]}-${parts[1]}-${parts[0]}`; 
            }
            dateObj = new Date(str);
        }
        if (!isNaN(dateObj.getTime())) {
            const d = String(dateObj.getDate()).padStart(2, '0');
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const y = dateObj.getFullYear();
            return `${d}-${m}-${y}`;
        }
        return raw;
    }

    document.addEventListener('DOMContentLoaded', () => {
       loadFromConfiguredUrl();
    });

    async function loadFromConfiguredUrl() {
        const msg = document.querySelector('#tys-wrapper #status-msg');
        msg.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Connecting to Secure Server...';

        try {
            const response = await fetch(EXCEL_FILE_URL + "&t=" + new Date().getTime());
            if (!response.ok) throw new Error("Network Error");
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const wb = XLSX.read(data, {type: 'array', cellDates: true});
            ALL_MEMBERS = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            if(ALL_MEMBERS.length) {
                msg.innerHTML = `<span style="color:#138808">✅ Connection Established. Database Loaded.</span>`;
            } else { msg.innerHTML = "Database is empty."; }
        } catch (error) {
            console.error(error);
            msg.innerHTML = `<span style="color:#e74c3c">❌ Connection Failed.</span>`;
        }
    }

    function verifyAndSearch() {
        const idInput = document.querySelector('#tys-wrapper #inputId').value.trim().toLowerCase();
        const phoneInput = document.querySelector('#tys-wrapper #inputPhone').value.trim().toLowerCase();
        const msg = document.querySelector('#tys-wrapper #status-msg');
        const grid = document.querySelector('#tys-wrapper #grid-area');

        if(!idInput || !phoneInput) {
            msg.innerHTML = '<span style="color:#e67e22">⚠ Please provide both credentials.</span>';
            grid.innerHTML = "";
            return;
        }

        msg.innerHTML = "Authenticating...";

        const filtered = ALL_MEMBERS.filter(member => {
            const mID = String(member[FIELD.id] || '').toLowerCase().trim();
            const mPhone = String(member[FIELD.phone] || '').toLowerCase().trim();
            return mID.includes(idInput) && mPhone.includes(phoneInput);
        });

        if(filtered.length === 0) {
            msg.innerHTML = '<span style="color:#e74c3c">❌ Verification Failed: Invalid Credentials.</span>';
            grid.innerHTML = "";
        } else {
            msg.innerHTML = `✅ Identity Verified. Generating Card...`;
            drawCards(filtered);
        }
    }

    function drawCards(data) {
        const grid = document.querySelector('#tys-wrapper #grid-area');
        grid.innerHTML = "";

        data.slice(0, 1).forEach((row, i) => {
            const fName = (row[FIELD.first] || '').trim();
            const lName = (row[FIELD.last] || '').trim();
            const father = (row[FIELD.father] || '').trim();
            const fullName = (fName + ' ' + lName).trim() || 'MEMBER NAME';
            const fatherDisplay = father || '_______________';
            const memID = row[FIELD.id] || '000';
            const membershipType = row[FIELD.role] || 'Lifetime'; 
            const issueDate = formatDate(row[FIELD.issueDate]);
            const memberPhone = row[FIELD.phone] || '_______________'; 
            const photo = row[FIELD.photo] || 'https://via.placeholder.com/150x200?text=PHOTO';

            // QR Logic
            let slugName = fName;
            if (lName) { slugName += " " + lName; } 
            else if (father) { slugName += " " + father; }
            const slug = slugName.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-');
            const finalQrUrl = `https://www.tirangayuvasamiti.org/tiranga-yuva-members/${slug}/`;

            const frontId = `card-front-${i}`;
            const backId = `card-back-${i}`;
            const qrId = `qr-${i}`;
            const wrapperId = `wrapper-${i}`;

            const html = `
            <div class="member-row" id="${wrapperId}">
                <div class="preview-col">
                    <div class="preview-label">Front (Vertical)</div>
                    <div class="id-card-wrapper" id="${frontId}">
                        <div class="id-card">
                            <div class="v-header">
                                <img src="${CACHED_LOGO}" class="v-header-logo">
                                <div class="v-org-name">${CONFIG.ngoName}</div>
                            </div>

                            <div class="v-body">
                                <div class="v-photo-frame">
                                    <img src="${photo}" class="v-user-photo">
                                </div>
                                <img src="${CACHED_STAMP}" class="v-stamp">

                                <div class="v-name-block">
                                    <div class="v-name-text">${fullName}</div>
                                    <div class="v-role-badge">${membershipType} Member</div>
                                </div>

                                <div class="v-details-table">
                                    <div class="v-row"><div class="v-lbl">Father's Name</div><div class="v-val">${fatherDisplay}</div></div>
                                    <div class="v-row"><div class="v-lbl">Membership ID</div><div class="v-val">TYS-${memID}</div></div>
                                    <div class="v-row"><div class="v-lbl">Contact Number</div><div class="v-val">${memberPhone}</div></div>
                                    <div class="v-row"><div class="v-lbl">Date of Issue</div><div class="v-val">${issueDate}</div></div>
                                </div>

                                <div class="v-qr-area">
                                    <div id="${qrId}" class="v-qr-box"></div>
                                </div>
                            </div>

                            <div class="v-footer">
                                ${CONFIG.ngoSub}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-col">
                    <div class="preview-label">Back (Vertical)</div>
                    <div class="id-card-wrapper" id="${backId}">
                        <div class="id-card">
                            <div class="vb-container">
                                <div class="vb-header">
                                    Official Identification
                                </div>
                                <div class="vb-body">
                                    <img src="${CACHED_LOGO}" class="vb-logo-main">
                                    
                                    <div class="vb-text-group">
                                        <div class="vb-label">If found, please return to:</div>
                                        <div class="vb-ngo-name">${CONFIG.ngoName}</div>

                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-location-dot"></i></div>
                                            <div class="vb-data">${CONFIG.contact.address}</div>
                                        </div>
                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-phone"></i></div>
                                            <div class="vb-data">${CONFIG.contact.phone}</div>
                                        </div>
                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-envelope"></i></div>
                                            <div class="vb-data">${CONFIG.contact.email}</div>
                                        </div>
                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-globe"></i></div>
                                            <div class="vb-data">${CONFIG.contact.web}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="vb-footer">
                                    <div class="vb-disclaimer">Property of ${CONFIG.ngoName}. Invalid without seal.</div>
                                    <div class="vb-strip"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 
                <button class="print-btn" onclick="printDoubleSided('${frontId}', '${backId}')">
                    <i class="fa-solid fa-print"></i>
                    <span>PRINT<br>CARD</span>
                </button>
            </div>
            `;
            grid.innerHTML += html;

            setTimeout(() => { 
                const qrDiv = document.getElementById(qrId);
                qrDiv.innerHTML = ""; 
                const tempContainer = document.createElement('div');
                new QRCode(tempContainer, { 
                    text: finalQrUrl, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H 
                });
                const canvas = tempContainer.querySelector('canvas');
                if(canvas) {
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL("image/png");
                    img.style.width = '100%'; img.style.height = 'auto'; img.style.display = 'block';
                    qrDiv.appendChild(img);
                }
            }, 100);
        });
    }

    function printDoubleSided(frontId, backId) {
        const frontHTML = document.getElementById(frontId).innerHTML;
        const backHTML = document.getElementById(backId).innerHTML;
        
        const win = window.open('', '', 'height=600,width=800');
        win.document.write('<html><head><title>Print ID Card</title>');
        win.document.write(`
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
            <style>
                @page { size: 54mm 85.6mm; margin: 0; }
                body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .print-page { width: 54mm; height: 85.6mm; position: relative; overflow: hidden; font-family: 'Montserrat', sans-serif; page-break-after: always; }
                .id-card { width: 100%; height: 100%; position: relative; background:white; display:flex; flex-direction:column; border: 1px solid #ddd; border-radius: 8px; }
                 
                /* REPEAT CSS FROM MAIN STYLE */
                .v-header { height: 18%; background: linear-gradient(180deg, #FF9933 0%, #FF8800 80%, #E67300 100%); width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 5; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding-top: 1mm; }
                .v-header-logo { width: 8mm; height: auto; margin-bottom: 1px; }
                .v-org-name { font-size: 8pt; font-weight: 900; color: white; text-transform: uppercase; margin: 0; line-height: 1; text-align: center; width: 92%; }
                
                .v-body { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; padding-top: 4mm; background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 5mm 5mm; }
                .v-body::before { content:''; position: absolute; left: 0; top:0; bottom:0; width: 1mm; background: linear-gradient(to bottom, #FF9933, #ffffff, #138808); }
                .v-body::after { content:''; position: absolute; right: 0; top:0; bottom:0; width: 1mm; background: linear-gradient(to bottom, #FF9933, #ffffff, #138808); }

                .v-photo-frame { width: 22mm; height: 26mm; background: white; border-radius: 4px; position: relative; z-index: 2; margin-bottom: 2mm; box-shadow: 0 0 0 2px white, 0 0 0 3px #FF9933; overflow: hidden; }
                .v-user-photo { width: 100%; height: 100%; object-fit: cover; }
                
                .v-name-block { text-align: center; margin-bottom: 3mm; z-index: 2; width: 85%; }
                .v-name-text { font-size: 10pt; font-weight: 800; color: #000080; text-transform: uppercase; line-height: 1.1; margin-bottom: 1px; }
                .v-role-badge { background: #000080; color: white; font-size: 4.5pt; font-weight: 700; padding: 2px 8px; border-radius: 50px; display: inline-block; text-transform: uppercase; }
                
                .v-details-table { width: 86%; z-index: 2; margin-bottom: auto; background: rgba(255,255,255,0.85); border: 1px solid rgba(0,0,0,0.05); border-radius: 6px; padding: 3px 6px; }
                .v-row { display: flex; align-items: center; margin-bottom: 2px; border-bottom: 1px solid rgba(0,0,0,0.06); padding: 1.5px 0; }
                .v-lbl { width: 45%; font-weight: 700; color: #666; font-size: 5pt; text-transform: uppercase; letter-spacing: 0.2px; }
                .v-val { width: 55%; font-weight: 700; color: #000; text-align: right; font-size: 5.5pt; }
                
                .v-qr-area { margin-bottom: 3mm; z-index: 2; position: relative; }
                .v-qr-box { width: 14mm; height: 14mm; padding: 1px; background: white; border: 1px solid #ddd; border-radius: 2px; }
                .v-qr-box img { width: 100%; height: 100%; }
                
                .v-footer { height: 6%; background: linear-gradient(180deg, #138808 0%, #0D6605 100%); width: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 5pt; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; border-top: 1px solid #0b5004; z-index: 5; }
                .v-stamp { position: absolute; top: 20mm; right: 6mm; width: 22mm; opacity: 0.9; mix-blend-mode: multiply; z-index: 10; transform: rotate(-20deg); }

                /* BACK SIDE */
                .vb-container { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; }
                
                .vb-header { height: 12%; background: linear-gradient(180deg, #FF9933, #e68a00); display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 0.5px; z-index: 2; }
                .vb-body { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 5mm; text-align: center; position: relative; background: #fff; }
                
                .vb-logo-main { width: 24mm; height: auto; margin-bottom: 4mm; margin-top: 3mm; opacity: 1.0; }
                
                .vb-text-group { z-index: 2; width: 100%; margin-top: auto; margin-bottom: auto; }
                .vb-label { font-size: 4.5pt; color: #999; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1px; }
                .vb-ngo-name { font-size: 8.5pt; font-weight: 900; color: #FF9933; text-transform: uppercase; margin-bottom: 4mm; line-height: 1.2; }
                
                .vb-contact-row { display: flex; align-items: flex-start; gap: 3mm; font-size: 6pt; color: #555; margin-bottom: 2.5mm; text-align: left; border-bottom: 1px dotted #eee; padding-bottom: 1mm; }
                .vb-icon { color: #138808; width: 4mm; text-align: center; font-size: 7pt; }
                .vb-data { flex: 1; line-height: 1.3; font-weight: 600; }
                
                .vb-footer { height: auto; padding-bottom: 2mm; text-align: center; z-index: 2; background: white; }
                .vb-disclaimer { font-size: 4pt; color: #aaa; font-weight: 500; font-style: italic; padding: 0 4mm; margin-bottom: 2mm; line-height: 1.2; }
                .vb-strip { height: 4mm; background: linear-gradient(180deg, #138808, #0B5E05); width: 100%; }
            </style>
        `);
        win.document.write('</head><body>');
        
        win.document.write('<div class="print-page">');
        win.document.write(frontHTML);
        win.document.write('</div>');

        win.document.write('<div class="print-page">');
        win.document.write(backHTML);
        win.document.write('</div>');
        
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        setTimeout(() => { win.print(); }, 1000);
    }
</script>
