<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYS ID Card System - Final Ultra Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* === GLOBAL RESET & VARIABLES === */
        :root {
            --navy: #002347;
            --saffron: #FF9933;
            --green: #138808;
            --bg-color: #e8ecf1;
        }

        html, body { 
            margin: 0; padding: 0; 
            background-color: var(--bg-color); 
            font-family: 'Segoe UI', sans-serif; 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
        }
        * { box-sizing: border-box; }

        /* === MAIN LAYOUT === */
        #app-container { 
            max-width: 1200px; margin: 0 auto; 
            padding: 40px 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }

        h2 { 
            color: #1a2a3a; text-align: center; 
            font-family: 'Montserrat', sans-serif; font-weight: 900; 
            text-transform: uppercase; letter-spacing: -1px; 
            margin-bottom: 5px; font-size: 32px; 
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }
        p.subtitle { color: #666; margin-bottom: 40px; font-weight: 600; text-align: center; }

        /* === SEARCH BOX STYLING === */
        .search-box {
            background: #fff; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            width: 100%; max-width: 450px;
            display: flex; flex-direction: column; gap: 20px; 
            border-top: 5px solid var(--saffron); margin-bottom: 50px;
        }
        
        .input-wrap { position: relative; width: 100%; }
        .input-wrap i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--navy); }
        
        .inp { 
            width: 100%; padding: 15px 15px 15px 45px; 
            border: 2px solid #eee; border-radius: 8px; 
            font-size: 16px; background: #f9f9f9; outline: none; transition: 0.3s; 
        }
        .inp:focus { border-color: var(--saffron); background: #fff; }
        
        .btn-action { 
            background: linear-gradient(135deg, var(--navy), #00152e); 
            color: white; border: none; padding: 15px; 
            border-radius: 8px; font-weight: 800; 
            text-transform: uppercase; cursor: pointer; transition: 0.3s; 
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,35,71,0.3); }
        
        #msg-box { text-align: center; font-weight: 700; color: #555; min-height: 20px; font-size: 14px; }

        /* === RESULT AREA === */
        #results-area { width: 100%; display: flex; flex-direction: column; gap: 50px; align-items: center; }
        
        .card-row {
            display: flex; gap: 60px; justify-content: center; align-items: center; flex-wrap: wrap;
            background: #fff; padding: 50px; border-radius: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        .side-col { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .side-label { font-weight: 800; color: #aaa; text-transform: uppercase; letter-spacing: 2px; font-size: 12px; }

        /* === ID CARD WRAPPER (Visual Display Only) === */
        .card-wrapper {
            width: 54mm; height: 86mm; 
            position: relative;
            background: transparent; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-radius: 3.18mm;
        }

        /* === ID CARD STRUCTURE (Used for Print & Download) === */
        .id-card {
            width: 54mm; height: 86mm;
            background: #fff;
            position: relative; overflow: hidden;
            border-radius: 3.18mm;
            font-family: 'Montserrat', sans-serif;
            border: 1px solid #000; /* Crisp border */
            display: flex; flex-direction: column;
            box-sizing: border-box;
        }

        /* --- FRONT SIDE --- */
        .front-header {
            height: 18%; background: var(--navy); 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 2mm 0 3mm; position: relative; 
            clip-path: polygon(0 0, 100% 0, 100% 88%, 0 100%);
            border-bottom: 2px solid var(--saffron); z-index: 5;
        }
        /* Saffron accent line at bottom of header */
        .front-header:after { content:''; position:absolute; bottom:0; left:0; width:100%; height:2px; background:var(--saffron); z-index:6; }

        .fh-logo { width: 8.5mm; height: auto; margin-right: 1.5mm; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .fh-title { color: white; font-family: 'Oswald', sans-serif; font-size: 7.5pt; line-height: 1.1; font-weight: 700; text-transform: uppercase; text-align: left; }
        
        .fh-qr { 
            width: 9mm; height: 9mm; background: white; padding: 1px; 
            border-radius: 2px; display: flex; align-items: center; justify-content: center; 
            margin-bottom: 2mm; margin-right: 1mm;
        }
        .fh-qr img { width: 100%; height: 100%; }

        .front-body {
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            padding-top: 3mm; position: relative;
            background-image: linear-gradient(#f4f4f4 1px, transparent 1px), linear-gradient(90deg, #f4f4f4 1px, transparent 1px);
            background-size: 4mm 4mm;
            padding-bottom: 6mm; /* Space for footer */
        }
        .fb-photo {
            width: 21mm; height: 25mm; 
            background: #eee; border: 1px solid #ccc; border-radius: 4px; 
            margin-bottom: 2mm; object-fit: cover; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .fb-name { 
            font-size: 10pt; font-weight: 900; color: var(--navy); 
            text-transform: uppercase; text-align: center; 
            line-height: 1.1; width: 95%; margin-bottom: 1px; 
        }
        .fb-role { 
            background: var(--saffron); color: white; 
            font-size: 5pt; font-weight: 700; padding: 1.5px 8px; 
            border-radius: 0px; text-transform: uppercase; margin-bottom: 2mm;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
        }
        
        .fb-table { width: 90%; display: flex; flex-direction: column; gap: 1px; margin-bottom: auto; }
        .fb-row { display: flex; font-size: 6pt; border-bottom: 1px solid #eee; padding-bottom: 1px; align-items: center; }
        .fb-lbl { width: 40%; color: #666; font-weight: 700; text-transform: uppercase; font-size: 5pt; letter-spacing: 0.2px; }
        .fb-val { width: 60%; color: #000; font-weight: 800; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Barcode Positioning */
        .fb-barcode { 
            position: absolute; bottom: 6mm; left: 50%; transform: translateX(-50%);
            height: 8mm; width: 90%; display: flex; justify-content: center; z-index: 2;
        }
        .fb-barcode svg { width: 100%; height: 100%; }

        .front-footer {
            position: absolute; bottom: 0; width: 100%; height: 5mm; 
            background: var(--navy); border-top: 1px solid var(--saffron);
            display: flex; align-items: center; justify-content: center; 
            color: var(--saffron); font-size: 5pt; font-weight: 800; 
            text-transform: uppercase; letter-spacing: 1px; z-index: 5;
        }

        /* --- BACK SIDE --- */
        .back-header { 
            height: 12%; background: var(--navy); 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: 800; font-size: 7.5pt; 
            text-transform: uppercase; letter-spacing: 1px; 
            border-bottom: 2px solid var(--saffron); 
        }
        .back-body { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            padding: 3mm; position: relative; 
        }
        .bb-logo { width: 16mm; margin-top: 1mm; opacity: 1; }
        .bb-title { 
            font-size: 8pt; font-weight: 900; color: var(--navy); 
            text-transform: uppercase; margin: 1mm 0 2mm 0; 
            width: 90%; text-align: center; 
        }
        
        .bb-qr-label { font-size: 5pt; font-weight: 800; color: var(--saffron); margin-bottom: 1px; text-transform: uppercase; }
        .bb-qr-box { 
            width: 14mm; height: 14mm; border: 1px solid #ddd; 
            padding: 1px; margin-bottom: 2mm; background: white;
        }
        .bb-qr-box img { width: 100%; height: 100%; }

        .bb-info { width: 100%; margin-bottom: 2mm; margin-top: 1mm; }
        .bb-row { display: flex; gap: 2mm; margin-bottom: 1.5mm; align-items: flex-start; }
        .bb-icon { color: var(--saffron); font-size: 6pt; width: 3mm; text-align: center; margin-top: 1px; }
        .bb-text { font-size: 5pt; font-weight: 600; color: #444; flex: 1; line-height: 1.2; text-align: left; }

        /* Terms & Signature Gap */
        .bb-terms { width: 100%; margin-top: auto; margin-bottom: 12mm; /* Increased Gap */ }
        .bb-terms h4 { margin: 0; font-size: 4pt; color: var(--navy); text-transform: uppercase; text-align: left; }
        .bb-terms p { margin: 0; font-size: 3.5pt; color: #666; line-height: 1.1; text-align: left; margin-top: 1px; }

        .bb-sign-area { 
            position: absolute; bottom: 6mm; right: 4mm; 
            text-align: center; z-index: 5; 
        }
        .bb-sign-line { width: 22mm; height: 1px; background: #000; margin-bottom: 1px; }
        .bb-sign-txt { font-size: 4pt; font-weight: 800; color: var(--navy); text-transform: uppercase; }
        
        .bb-stamp { 
            position: absolute; bottom: 2mm; right: 0; 
            width: 20mm; opacity: 0.85; mix-blend-mode: multiply; 
            transform: rotate(-15deg); pointer-events: none; z-index: 10;
        }

        .back-footer { 
            position: absolute; bottom: 0; width: 100%; height: 5mm; 
            background: var(--green); 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 4.5pt; font-weight: 600; text-transform: uppercase; 
        }

        /* === ACTION BUTTONS === */
        .btn-group { display: flex; gap: 20px; flex-direction: column; justify-content: center; }
        .tool-btn {
            border: none; padding: 15px 25px; border-radius: 10px; 
            cursor: pointer; color: white; font-weight: 800; font-size: 14px;
            display: flex; flex-direction: column; align-items: center; gap: 5px; 
            min-width: 140px; transition: 0.3s;
        }
        .btn-print { background: var(--saffron); box-shadow: 0 5px 15px rgba(255, 153, 51, 0.3); }
        .btn-print:hover { transform: translateY(-3px); background: #e68a00; }
        
        .btn-dl { background: #2980b9; box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3); }
        .btn-dl:hover { transform: translateY(-3px); background: #2471a3; }

        @media (max-width: 768px) {
            .card-row { flex-direction: column; padding: 20px; }
            .btn-group { flex-direction: row; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div class="app-box">
        <h2>ID Card Verification</h2>
        <p class="subtitle">Official Member Database</p>

        <div class="search-box">
            <div class="input-wrap">
                <i class="fa-solid fa-id-badge"></i>
                <input type="text" id="inputId" class="inp" placeholder="Member ID (e.g. YM-101)">
            </div>
            <div class="input-wrap">
                <i class="fa-solid fa-phone"></i>
                <input type="text" id="inputPhone" class="inp" placeholder="Registered Phone">
            </div>
            <button class="btn-action" onclick="verifyAndSearch()">Verify & Generate</button>
            <div id="msg-box"></div>
        </div>

        <div id="results-area"></div>
    </div>
</div>

<script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1p1ynKWyRErPwczTcMkffZfQ7dhOiV9buv_gIVRK3uh0/export?format=csv&gid=85144492";
    
    // CONFIG
    const CFG = {
        org: "Tiranga Yuva Samiti",
        logo: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCaJCRPLvQgi9REoAvb9b4H4Vvh6RhAmMRGwGEolXIqS2nxxCa9-jS7qexF2JL5puwPOEk-2q7ubDKeL-m-BM0_7_uHrI5EnBXue7deGtgta4UyCDnI43AkB1KBN8PV4G00fg1vW2La338AyzZkHvXpzt49papqeYLt9NDXMcTnvsceg/s1600/TYS-White.png",
        stamp: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEif3QsddJJfS7s0DWat3m-JGugl9Jf3PHlxuPenO9wCWmjqiqV2UZ2IBMA_0b2ID8Uk1Ukwozo206pIjMGCEm5rK6e24u33ZDaSUUvnVzfsMQX6aY4BoleEeCGB3PMBfh4VER_I5Qsac0CHXkwtvVu5kuefZWrr9qr5MEOPyL8_tpkKow/s1600/Naveen%20Stamp.jpg",
        donate: "https://www.tirangayuvasamiti.org/donate/",
        contact: {
            addr: "VPO Khanda 9R, Tehsil Kharkhoda, Sonipat, Haryana – 131402",
            ph: "+91 90535 75169",
            em: "info@tirangayuvasamiti.org",
            wb: "www.tirangayuvasamiti.org"
        }
    };

    let MEM_DATA = [];

    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
        const box = document.getElementById('msg-box');
        box.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Loading Database...';
        try {
            const res = await fetch(SHEET_URL + "&t=" + Date.now());
            const buf = await res.arrayBuffer();
            const wb = XLSX.read(new Uint8Array(buf), {type:'array', cellDates:true});
            MEM_DATA = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            box.innerHTML = MEM_DATA.length ? `<span style="color:green">✅ Database Ready (${MEM_DATA.length} members)</span>` : "Database Empty";
        } catch(e) { box.innerHTML = `<span style="color:red">❌ Connection Failed</span>`; }
    }

    function verifyAndSearch() {
        const id = document.getElementById('inputId').value.trim().toLowerCase();
        const ph = document.getElementById('inputPhone').value.trim().toLowerCase();
        const box = document.getElementById('msg-box');
        const grid = document.getElementById('results-area');
        grid.innerHTML = "";

        if(!id || !ph) { box.innerText = "⚠ Enter both Member ID and Phone."; return; }

        const found = MEM_DATA.filter(m => 
            String(m.id).toLowerCase().includes(id) && String(m.phone).toLowerCase().includes(ph)
        );

        if(!found.length) { box.innerHTML = `<span style="color:red">❌ No Match Found.</span>`; return; }
        
        box.innerHTML = `<span style="color:green">✅ Verified! Generating Card...</span>`;
        renderCard(found[0]);
    }

    function renderCard(data) {
        const grid = document.getElementById('results-area');
        
        const fName = (data.firstname || '').trim();
        const lName = (data.lastname || '').trim();
        const fullName = `${fName} ${lName}`;
        const father = data.father_name || '________';
        const memId = data.id || '000';
        const phone = data.phone || '________';
        const role = data.membership || 'Member';
        const joined = formatDate(data.joined);
        const photoUrl = data.photo_url || 'https://via.placeholder.com/150';
        
        let slug = fName;
        if(lName) slug += " " + lName;
        slug = slug.toLowerCase().replace(/[^a-z0-9]/g, '-');
        const qrUrl = `https://www.tirangayuvasamiti.org/tiranga-yuva-members/${slug}/`;

        const uId = Date.now();
        
        grid.innerHTML = `
        <div class="card-row">
            <div class="side-col">
                <div class="side-label">Front Side</div>
                <div class="card-wrapper" id="front-${uId}">
                    <div class="id-card">
                        <div class="front-header">
                            <div style="display:flex; align-items:center;">
                                <img src="${CFG.logo}" class="fh-logo" crossorigin="anonymous">
                                <div class="fh-title">${CFG.org}</div>
                            </div>
                            <div class="fh-qr" id="qr-head-${uId}"></div>
                        </div>
                        <div class="front-body">
                            <img src="${photoUrl}" class="fb-photo" crossorigin="anonymous">
                            <div class="fb-name">${fullName}</div>
                            <div class="fb-role">${role}</div>
                            <div class="fb-table">
                                <div class="fb-row"><div class="fb-lbl">FATHER'S NAME</div><div class="fb-val">${father}</div></div>
                                <div class="fb-row"><div class="fb-lbl">MEMBER ID</div><div class="fb-val">TYS-${memId}</div></div>
                                <div class="fb-row"><div class="fb-lbl">CONTACT</div><div class="fb-val">${phone}</div></div>
                                <div class="fb-row"><div class="fb-lbl">ISSUED ON</div><div class="fb-val">${joined}</div></div>
                            </div>
                            <div class="fb-barcode"><svg id="bar-${uId}"></svg></div>
                        </div>
                        <div class="front-footer">${CFG.org}</div>
                    </div>
                </div>
            </div>

            <div class="side-col">
                <div class="side-label">Back Side</div>
                <div class="card-wrapper" id="back-${uId}">
                    <div class="id-card">
                        <div class="back-header">OFFICIAL IDENTIFICATION</div>
                        <div class="back-body">
                            <img src="${CFG.logo}" class="bb-logo" crossorigin="anonymous">
                            <div class="bb-title">${CFG.org}</div>
                            
                            <div class="bb-qr-label">SCAN TO VERIFY MEMBER</div>
                            <div class="bb-qr-box" id="qr-back-${uId}"></div>

                            <div class="bb-info">
                                <div class="bb-row"><div class="bb-icon"><i class="fa-solid fa-location-dot"></i></div><div class="bb-text">${CFG.contact.addr}</div></div>
                                <div class="bb-row"><div class="bb-icon"><i class="fa-solid fa-phone"></i></div><div class="bb-text">${CFG.contact.ph}</div></div>
                                <div class="bb-row"><div class="bb-icon"><i class="fa-solid fa-envelope"></i></div><div class="bb-text">${CFG.contact.em}</div></div>
                                <div class="bb-row"><div class="bb-icon"><i class="fa-solid fa-globe"></i></div><div class="bb-text">${CFG.contact.wb}</div></div>
                            </div>

                            <div class="bb-terms">
                                <h4>Terms & Conditions:</h4>
                                <p>1. This card is non-transferable property of the organization.<br>2. If found, return to the address above.</p>
                            </div>

                            <div class="bb-sign-area">
                                <div class="bb-sign-line"></div>
                                <div class="bb-sign-txt">AUTHORIZED SIGNATORY</div>
                                <img src="${CFG.stamp}" class="bb-stamp" crossorigin="anonymous">
                            </div>
                        </div>
                        <div class="back-footer">Together We Serve • Jai Hind</div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="tool-btn btn-print" onclick="printCards('front-${uId}', 'back-${uId}')">
                    <i class="fa-solid fa-print" style="font-size:20px;"></i> PRINT<br>CARD
                </button>
                <button class="tool-btn btn-dl" onclick="downloadImages('front-${uId}', 'back-${uId}', '${fullName}')">
                    <i class="fa-solid fa-download" style="font-size:20px;"></i> DOWNLOAD<br>IMAGE
                </button>
            </div>
        </div>`;

        setTimeout(() => {
            const q1 = document.getElementById(`qr-head-${uId}`);
            new QRCode(q1, { text: CFG.donate, width: 64, height: 64, correctLevel: QRCode.CorrectLevel.L });
            
            const q2 = document.getElementById(`qr-back-${uId}`);
            new QRCode(q2, { text: qrUrl, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });

            JsBarcode(`#bar-${uId}`, `TYS-${memId}`, {
                format:"CODE128", displayValue:false, height:30, margin:0, background:"transparent", width:1.5
            });
        }, 100);
    }

    function formatDate(raw) {
        if(!raw) return '________';
        let d = new Date(raw);
        if(isNaN(d.getTime())) return raw;
        return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
    }

    // === PRINT FUNCTION ===
    function printCards(fid, bid) {
        const fHtml = document.getElementById(fid).innerHTML;
        const bHtml = document.getElementById(bid).innerHTML;
        
        const win = window.open('', '', 'width=900,height=700');
        win.document.write(`
            <html><head><title>Print ID Card</title>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
                /* ZERO MARGIN & AUTO SIZE */
                @page { size: auto; margin: 0; }
                body { margin: 0; padding: 0; width: 100%; height: 100%; background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                
                /* CENTER THE CARD ON THE PAPER */
                .print-page { 
                    width: 100vw; height: 100vh; 
                    display: flex; justify-content: center; align-items: center; 
                    page-break-after: always; 
                }

                /* REPEAT CSS CLASSES FOR PRINT WINDOW */
                * { box-sizing: border-box; }
                .id-card { width: 54mm; height: 86mm; border: 1px solid #000; border-radius: 3.18mm; overflow: hidden; position: relative; background: white; display: flex; flex-direction: column; font-family: 'Montserrat', sans-serif; }
                
                /* Front Side */
                .front-header { height: 18%; background: #002347; display: flex; align-items: center; justify-content: space-between; padding: 0 2mm 0 3mm; clip-path: polygon(0 0, 100% 0, 100% 88%, 0 100%); border-bottom: 2px solid #FF9933; z-index: 5; }
                .front-header:after { content:''; position:absolute; bottom:0; left:0; width:100%; height:2px; background:#FF9933; z-index:6; }
                .fh-logo { width: 8.5mm; margin-right: 1.5mm; }
                .fh-title { color: white; font-family: 'Oswald', sans-serif; font-size: 7.5pt; line-height: 1.1; font-weight: 700; text-transform: uppercase; text-align: left; }
                .fh-qr { width: 9mm; height: 9mm; background: white; padding: 1px; display: flex; align-items: center; justify-content: center; margin-bottom: 2mm; margin-right: 1mm; }
                .fh-qr img { width: 100%; height: 100%; }
                
                .front-body { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 2mm; background-image: linear-gradient(#f4f4f4 1px, transparent 1px), linear-gradient(90deg, #f4f4f4 1px, transparent 1px); background-size: 4mm 4mm; padding-bottom: 6mm; }
                .fb-photo { width: 21mm; height: 25mm; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 2mm; object-fit: cover; }
                .fb-name { font-size: 10pt; font-weight: 900; color: #002347; text-transform: uppercase; text-align: center; line-height: 1.1; width: 95%; margin-bottom: 1px; }
                .fb-role { background: #FF9933; color: white; font-size: 5pt; font-weight: 700; padding: 1.5px 8px; border-radius: 0px; text-transform: uppercase; margin-bottom: 2mm; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%); }
                .fb-table { width: 90%; display: flex; flex-direction: column; gap: 1px; margin-bottom: auto; }
                .fb-row { display: flex; font-size: 6pt; border-bottom: 1px solid #eee; padding-bottom: 1px; align-items: center; }
                .fb-lbl { width: 40%; color: #666; font-weight: 700; text-transform: uppercase; font-size: 5pt; letter-spacing: 0.2px; }
                .fb-val { width: 60%; color: #000; font-weight: 800; text-align: right; }
                .fb-barcode { position: absolute; bottom: 6mm; left: 50%; transform: translateX(-50%); height: 8mm; width: 90%; display: flex; justify-content: center; z-index: 2; }
                .fb-barcode svg { width: 100%; height: 100%; }
                .front-footer { position: absolute; bottom: 0; width: 100%; height: 5mm; background: #002347; border-top: 1px solid #FF9933; display: flex; align-items: center; justify-content: center; color: #FF9933; font-size: 5pt; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; z-index: 5; }

                /* Back Side */
                .back-header { height: 12%; background: #002347; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 7.5pt; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #FF9933; }
                .back-body { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 3mm; position: relative; }
                .bb-logo { width: 16mm; margin-top: 1mm; }
                .bb-title { font-size: 8pt; font-weight: 900; color: #002347; text-transform: uppercase; margin: 1mm 0 2mm 0; width: 90%; text-align: center; }
                .bb-qr-label { font-size: 5pt; font-weight: 800; color: #FF9933; margin-bottom: 1px; text-transform: uppercase; }
                .bb-qr-box { width: 14mm; height: 14mm; border: 1px solid #ddd; padding: 1px; margin-bottom: 2mm; }
                .bb-qr-box img { width: 100%; height: 100%; }
                .bb-info { width: 100%; margin-bottom: 2mm; margin-top: 1mm; }
                .bb-row { display: flex; gap: 2mm; margin-bottom: 1.5mm; }
                .bb-icon { color: #FF9933; font-size: 6pt; width: 3mm; text-align: center; margin-top: 1px; }
                .bb-text { font-size: 5pt; font-weight: 600; color: #444; flex: 1; text-align: left; }
                .bb-terms { width: 100%; margin-top: auto; margin-bottom: 12mm; }
                .bb-terms h4 { margin: 0; font-size: 4pt; color: #002347; text-transform: uppercase; text-align: left; }
                .bb-terms p { margin: 0; font-size: 3.5pt; color: #666; text-align: left; margin-top: 1px; }
                .bb-sign-area { position: absolute; bottom: 6mm; right: 4mm; text-align: center; z-index: 5; }
                .bb-sign-line { width: 22mm; height: 1px; background: #000; margin-bottom: 1px; }
                .bb-sign-txt { font-size: 4pt; font-weight: 800; color: #002347; text-transform: uppercase; }
                .bb-stamp { position: absolute; bottom: 2mm; right: 0; width: 20mm; opacity: 0.85; mix-blend-mode: multiply; transform: rotate(-15deg); z-index: 10; }
                .back-footer { position: absolute; bottom: 0; width: 100%; height: 5mm; background: #138808; display: flex; align-items: center; justify-content: center; color: white; font-size: 4.5pt; font-weight: 600; text-transform: uppercase; }
            </style>
            </head><body>
                <div class="print-page">${fHtml}</div>
                <div class="print-page">${bHtml}</div>
            </body></html>
        `);
        win.document.close();
        setTimeout(() => { win.focus(); win.print(); }, 1000);
    }

    // === DOWNLOAD FUNCTION ===
    async function downloadImages(fid, bid, name) {
        const safeName = name.replace(/\s+/g, '_');
        
        // Front
        const fEl = document.querySelector(`#${fid} .id-card`);
        const c1 = await html2canvas(fEl, { scale: 4, useCORS: true, backgroundColor: null });
        downloadURI(c1.toDataURL("image/png"), `TYS_${safeName}_FRONT.png`);

        // Back
        setTimeout(async () => {
            const bEl = document.querySelector(`#${bid} .id-card`);
            const c2 = await html2canvas(bEl, { scale: 4, useCORS: true, backgroundColor: null });
            downloadURI(c2.toDataURL("image/png"), `TYS_${safeName}_BACK.png`);
        }, 1000);
    }

    function downloadURI(uri, name) {
        var link = document.createElement("a");
        link.download = name;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
