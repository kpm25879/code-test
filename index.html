<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Industrial OMR Sheet Generator V3. Cyber-styled, high-precision Optical Mark Recognition sheet builder for exams and surveys.">
    <title>OMR COMMANDER | Industrial Sheet Generator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#050505',
                            dark: '#0a0a0f',
                            panel: '#111116',
                            border: '#2a2a35',
                            primary: '#00f0ff', // Cyber Blue
                            secondary: '#7000ff', // Cyber Purple
                            accent: '#ff003c', // Cyber Red (Dropout)
                        }
                    },
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        body: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --dropout-color: #ff003c; /* Standard OMR Dropout Red/Pink */
            --scan-black: #000000;
        }

        /* --- CYBER UI BACKGROUND --- */
        body {
            background-color: #050505;
            color: #e2e8f0;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- PAPER PHYSICS (A4 STRICT) --- */
        .paper-wrapper {
            transform-origin: top center;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 50px;
            box-shadow: 0 0 100px rgba(0, 240, 255, 0.1);
        }

        .sheet-container {
            width: 210mm;
            height: 297mm; /* A4 ISO */
            background: white;
            position: relative;
            padding: 10mm;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            color: black;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* --- OMR COMPONENTS --- */
        .omr-bubble {
            width: 12px;
            height: 12px;
            border: 1px solid var(--dropout-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 7.5px;
            color: var(--dropout-color);
            font-weight: 800;
            line-height: 1;
        }

        .omr-box {
            width: 14px;
            height: 18px;
            border: 1.5px solid var(--dropout-color);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--scan-black);
            margin: 1px;
        }

        /* Machine Readable Marks */
        .fiducial { position: absolute; background: black; z-index: 60; }
        /* Top Left */
        .f-tl-h { top: 10mm; left: 10mm; width: 25px; height: 6px; }
        .f-tl-v { top: 10mm; left: 10mm; width: 6px; height: 25px; }
        /* Top Right */
        .f-tr-h { top: 10mm; right: 10mm; width: 25px; height: 6px; }
        .f-tr-v { top: 10mm; right: 10mm; width: 6px; height: 25px; }
        /* Bottom Left */
        .f-bl-h { bottom: 10mm; left: 10mm; width: 25px; height: 6px; }
        .f-bl-v { bottom: 10mm; left: 10mm; width: 6px; height: 25px; }
        /* Bottom Right */
        .f-br-h { bottom: 10mm; right: 10mm; width: 25px; height: 6px; }
        .f-br-v { bottom: 10mm; right: 10mm; width: 6px; height: 25px; }

        .timing-track {
            position: absolute; left: 6mm; top: 40mm; bottom: 40mm;
            width: 4px; display: flex; flex-direction: column; justify-content: space-between;
        }
        .track-dash { height: 3px; background: black; width: 100%; }

        /* Question Grid Layout */
        .q-grid {
            display: grid;
            gap: 6mm; /* Gap between columns */
            align-content: start;
            height: 100%;
        }
        .q-col { border-right: 1px dashed #ccc; padding-right: 2mm; }
        .q-col:last-child { border-right: none; }
        .q-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 3.5px; }
        .q-idx { font-size: 9px; font-weight: bold; width: 18px; text-align: right; margin-right: 4px; font-family: 'JetBrains Mono'; }

        /* Print Logic */
        @media print {
            body { background: white; }
            body * { visibility: hidden; }
            .sheet-container, .sheet-container * { visibility: visible; }
            .sheet-container {
                position: absolute; left: 0; top: 0; margin: 0;
                box-shadow: none; transform: none !important;
            }
            .no-print { display: none !important; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0f; }
        ::-webkit-scrollbar-thumb { background: #2a2a35; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00f0ff; }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans antialiased selection:bg-cyber-primary selection:text-black">

    <nav class="h-16 border-b border-cyber-border bg-cyber-dark/90 backdrop-blur-md sticky top-0 z-50 no-print flex items-center justify-between px-6">
        <div class="flex items-center gap-3">
            <div class="text-cyber-primary text-2xl"><i class="fa-solid fa-microchip"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-widest text-white">OMR <span class="text-cyber-primary">COMMANDER</span></h1>
                <p class="text-[9px] text-gray-500 uppercase tracking-[0.2em]">Industrial Sheet Processor v4.0</p>
            </div>
        </div>
        <div class="hidden md:flex gap-6 text-sm font-medium text-gray-400">
            <a href="#editor" class="hover:text-cyber-primary transition">Editor</a>
            <a href="#knowledge" class="hover:text-cyber-primary transition">Knowledge Base</a>
        </div>
    </nav>

    <div class="flex-grow flex flex-col lg:flex-row h-[calc(100vh-64px)] overflow-hidden">
        
        <aside class="w-full lg:w-[400px] bg-cyber-panel border-r border-cyber-border flex flex-col no-print z-40 h-full">
            <div class="p-4 border-b border-cyber-border bg-cyber-dark/50">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-cyber-secondary uppercase tracking-widest"><i class="fa-solid fa-sliders mr-2"></i>Parameters</h2>
                    <span class="text-[10px] bg-cyber-border px-2 py-0.5 rounded text-gray-300 font-mono">READY</span>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto p-5 space-y-6 custom-scrollbar">
                
                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-400 uppercase">Institution & Exam</label>
                    <input type="text" id="inpInstitute" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-sm text-cyber-primary focus:border-cyber-primary outline-none font-mono" placeholder="Institute Name" value="CYBERDYNE SYSTEMS UNIVERSITY">
                    <input type="text" id="inpExam" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-sm text-gray-300 focus:border-cyber-primary outline-none font-mono" placeholder="Exam Name" value="APTITUDE TEST SERIES-A">
                </div>

                <div class="space-y-3 p-3 bg-cyber-dark rounded border border-cyber-border">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-gray-400">Include Logo</label>
                        <input type="checkbox" id="checkLogo" class="accent-cyber-primary" checked>
                    </div>
                    <input type="file" id="inpLogo" accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-cyber-border file:text-cyber-primary hover:file:bg-cyber-border/80 cursor-pointer">
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-cyber-primary uppercase">Grid Matrix</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">QUESTIONS</span>
                            <input type="number" id="inpTotalQ" value="120" min="10" max="200" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-sm text-white font-mono text-center">
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">COLUMNS</span>
                            <select id="inpCols" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-sm text-white text-center">
                                <option value="3">3 Cols</option>
                                <option value="4" selected>4 Cols</option>
                                <option value="5">5 Cols</option>
                            </select>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">OPTIONS</span>
                            <select id="inpOpts" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-sm text-white text-center">
                                <option value="4">A B C D</option>
                                <option value="5">A B C D E</option>
                            </select>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">ROLL DIGITS</span>
                            <input type="number" id="inpRollDig" value="8" min="5" max="12" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-sm text-white font-mono text-center">
                        </div>
                    </div>
                </div>

                <div class="space-y-3 p-3 bg-cyber-dark rounded border border-cyber-border">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-gray-400">Booklet No. Block</label>
                        <input type="checkbox" id="checkBooklet" class="accent-cyber-primary" checked>
                    </div>
                    <div id="bookletConfig" class="grid grid-cols-2 gap-2">
                        <input type="number" id="inpBookletDig" value="6" class="bg-cyber-black border border-cyber-border rounded p-1 text-xs text-center text-white" placeholder="Digits">
                        <span class="text-[10px] flex items-center text-gray-500">Digits Count</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-400 uppercase">Machine Codes</label>
                    <input type="text" id="inpQrData" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-xs text-gray-300 font-mono" placeholder="QR Data (Default: Auto)" value="BATCH-2026-SECURE">
                    <input type="text" id="inpBarData" class="w-full bg-cyber-black border border-cyber-border rounded p-2 text-xs text-gray-300 font-mono" placeholder="Barcode (Default: Auto)" value="OMR-V4-IND">
                </div>

            </div>

            <div class="p-4 border-t border-cyber-border bg-cyber-dark sticky bottom-0">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.render()" class="bg-cyber-border hover:bg-gray-700 text-white py-2 rounded text-xs font-bold uppercase tracking-wider transition">
                        <i class="fa-solid fa-arrows-rotate mr-1"></i> Refresh
                    </button>
                    <button onclick="app.download()" class="bg-gradient-to-r from-cyber-secondary to-cyber-primary hover:opacity-90 text-black py-2 rounded text-xs font-bold uppercase tracking-wider transition shadow-[0_0_15px_rgba(0,240,255,0.4)]">
                        <i class="fa-solid fa-file-pdf mr-1"></i> Export PDF
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-grow relative bg-black/50 overflow-hidden flex flex-col">
            
            <div class="absolute top-4 left-1/2 -translate-x-1/2 z-30 bg-cyber-panel border border-cyber-border rounded-full px-4 py-1 flex items-center gap-4 shadow-xl no-print">
                <button onclick="app.zoom(-0.1)" class="text-gray-400 hover:text-white"><i class="fa-solid fa-minus"></i></button>
                <span id="lblZoom" class="text-xs font-mono text-cyber-primary">100%</span>
                <button onclick="app.zoom(0.1)" class="text-gray-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="scrollContainer" class="flex-grow overflow-auto p-10 flex justify-center items-start custom-scrollbar">
                
                <div id="paperWrapper" class="paper-wrapper">
                    <div id="sheet" class="sheet-container">
                        
                        <div class="fiducial f-tl-h"></div><div class="fiducial f-tl-v"></div>
                        <div class="fiducial f-tr-h"></div><div class="fiducial f-tr-v"></div>
                        <div class="fiducial f-bl-h"></div><div class="fiducial f-bl-v"></div>
                        <div class="fiducial f-br-h"></div><div class="fiducial f-br-v"></div>
                        
                        <div class="timing-track" id="timingTrack"></div>

                        <header class="h-[35mm] border-b-2 border-[var(--dropout-color)] flex gap-4 pb-2 mb-2">
                            <div id="logoContainer" class="w-[25mm] flex items-center justify-center border border-gray-100 rounded">
                                <span class="text-[8px] text-gray-300 text-center">LOGO<br>AREA</span>
                                <img id="renderLogo" class="max-w-full max-h-full object-contain hidden">
                            </div>

                            <div class="flex-grow flex flex-col justify-center text-center">
                                <h1 id="outInst" class="text-2xl font-black text-[var(--dropout-color)] uppercase leading-none tracking-tight">INSTITUTE NAME</h1>
                                <h2 id="outExam" class="text-sm font-bold text-gray-800 uppercase tracking-[0.2em] mt-1 border-t border-gray-300 inline-block px-6 mx-auto pt-1">EXAM NAME</h2>
                                <p class="text-[9px] mt-2 font-mono">Fill the sheet carefully using Blue/Black Ball Point Pen.</p>
                            </div>

                            <div class="w-[40mm] flex flex-col justify-between items-end">
                                <div class="text-[9px] font-mono text-right">
                                    <div class="border border-black px-2 py-1 mb-1 font-bold">SIDE-1</div>
                                </div>
                                <svg id="barcode"></svg>
                            </div>
                        </header>

                        <section class="h-[45mm] flex gap-2 mb-4">
                            
                            <div class="w-[45mm] border border-[var(--dropout-color)] rounded p-2 bg-pink-50/30">
                                <h3 class="text-[9px] font-bold text-[var(--dropout-color)] border-b border-pink-200 mb-1">MARKING EXAMPLES</h3>
                                <div class="flex flex-col gap-2 mt-2">
                                    <div class="flex items-center gap-2">
                                        <div class="omr-bubble bg-[var(--dropout-color)] text-white" style="border:none"><i class="fa-solid fa-check text-[8px]"></i></div>
                                        <span class="text-[7px] uppercase font-bold">Correct</span>
                                    </div>
                                    <div class="flex gap-1 items-center">
                                        <div class="omr-bubble relative"><i class="fa-solid fa-xmark absolute text-black"></i></div>
                                        <div class="omr-bubble relative"><div class="w-1.5 h-1.5 bg-black rounded-full opacity-50"></div></div>
                                        <span class="text-[7px] uppercase font-bold">Wrong</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col">
                                <div class="bg-[var(--dropout-color)] text-white text-[9px] font-bold text-center py-0.5 rounded-t">ROLL NO.</div>
                                <div class="flex-grow border border-[var(--dropout-color)] border-t-0 rounded-b p-1 flex flex-col items-center justify-between">
                                    <div id="rollInputs" class="flex gap-[1px]"></div>
                                    <div id="rollBubbles" class="flex gap-[1px]"></div>
                                </div>
                            </div>

                            <div id="bookletSection" class="flex flex-col">
                                <div class="bg-black text-white text-[9px] font-bold text-center py-0.5 rounded-t">BOOKLET NO.</div>
                                <div class="flex-grow border border-black border-t-0 rounded-b p-1 flex flex-col items-center justify-between">
                                    <div id="bookletInputs" class="flex gap-[1px]"></div>
                                    <div id="bookletBubbles" class="flex gap-[1px]"></div>
                                </div>
                            </div>

                            <div class="flex-grow border border-gray-400 rounded p-1.5 relative">
                                <span class="absolute top-[-7px] left-2 bg-white px-1 text-[8px] font-bold text-gray-500 uppercase">Candidate Info</span>
                                <div class="h-full flex flex-col gap-2 pt-2">
                                    <div class="border-b border-dotted border-gray-400 pb-1">
                                        <span class="text-[7px] text-gray-400 uppercase">Name (In Block Letters)</span>
                                    </div>
                                    <div class="border-b border-dotted border-gray-400 pb-1">
                                        <span class="text-[7px] text-gray-400 uppercase">Center Code & Name</span>
                                    </div>
                                    <div class="border-b border-dotted border-gray-400 pb-1">
                                        <span class="text-[7px] text-gray-400 uppercase">Subject</span>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <div class="flex-grow relative">
                            <div class="h-4 w-full flex items-center justify-center">
                                <div class="bg-[var(--dropout-color)] text-white text-[9px] px-6 py-0.5 rounded-full shadow-sm font-bold tracking-widest">ANSWERS</div>
                            </div>
                            
                            <div id="qGrid" class="q-grid mt-2 h-full pb-2">
                                </div>
                        </div>

                        <footer class="h-[25mm] border-t-2 border-black flex items-end justify-between pt-2">
                            <div class="flex gap-4">
                                <div class="w-[20mm]">
                                    <div class="h-10 border-b border-black mb-1"></div>
                                    <div class="text-[7px] text-center font-bold uppercase">Sig. of Candidate</div>
                                </div>
                                <div class="w-[20mm]">
                                    <div class="h-10 border-b border-black mb-1"></div>
                                    <div class="text-[7px] text-center font-bold uppercase">Sig. of Invigilator</div>
                                </div>
                                <div class="w-[30mm] h-14 border border-gray-300 bg-gray-50 flex items-center justify-center">
                                    <span class="text-[7px] text-gray-300 rotate-[-15deg] font-bold text-2xl uppercase opacity-20">Stamp</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <div class="text-[8px] text-right text-gray-400 font-mono leading-tight">
                                    SHEET ID: <span class="text-black font-bold">GEN-8839</span><br>
                                    DO NOT FOLD
                                </div>
                                <div id="qrCode" class="mix-blend-multiply"></div>
                            </div>
                        </footer>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <section id="knowledge" class="bg-cyber-dark text-gray-300 py-16 px-6 border-t border-cyber-border no-print">
        <div class="max-w-5xl mx-auto">
            <h2 class="text-3xl font-bold text-white mb-8 border-l-4 border-cyber-primary pl-4">Industrial OMR Knowledge Base</h2>
            
            <div class="grid md:grid-cols-2 gap-12">
                <div class="space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold text-cyber-primary mb-3">Understanding Fiducials & Timing Tracks</h3>
                        <p class="text-sm leading-relaxed text-gray-400">
                            The four black rectangles at the corners of this sheet are called <strong>Fiducials</strong> or "Anchor Points." Modern OMR scanners (optical mark recognition) and mobile apps (like ZipGrade, OMR Scanner) use these to calculate the perspective distortion of the paper.
                        </p>
                        <p class="text-sm leading-relaxed text-gray-400 mt-2">
                            The <strong>Timing Track</strong> (the ladder-like marks on the left) tells the scanner exactly where a row of bubbles exists. This generator aligns these tracks perfectly with the question rows to ensure 99.9% scanning accuracy on hardware like Sekonic or Scantron machines.
                        </p>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-cyber-primary mb-3">Paper & Printing Specification</h3>
                        <ul class="list-disc list-inside text-sm text-gray-400 space-y-2">
                            <li><strong>Paper Size:</strong> A4 (210mm x 297mm) is mandatory.</li>
                            <li><strong>Paper Weight:</strong> 100 GSM recommended preventing ink bleed-through.</li>
                            <li><strong>Printer Settings:</strong> Disable "Fit to Page" or "Scale." Print at 100% scale.</li>
                            <li><strong>Color:</strong> Color printing is preferred for the "Dropout Color" (Pink/Red). Scanners emit red light, making the red circles invisible to the sensor, leaving only the dark pencil marks visible.</li>
                        </ul>
                    </div>
                </div>

                <div class="space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold text-cyber-primary mb-3">Data Security & Logic</h3>
                        <p class="text-sm leading-relaxed text-gray-400">
                            This OMR Builder Pro operates entirely on the <strong>Client-Side</strong>. No student data, institute names, or layout configurations are sent to any server. The generation logic uses the browser's DOM rendering engine to draw vector-sharp HTML elements, which are then rasterized into a PDF using <code>html2pdf</code> logic.
                        </p>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-cyber-primary mb-3">FAQ</h3>
                        <div class="space-y-4">
                            <details class="bg-cyber-panel border border-cyber-border rounded p-3 group">
                                <summary class="cursor-pointer font-bold text-white flex justify-between">
                                    Can I use this for Competitive Exams? <i class="fa-solid fa-chevron-down group-open:rotate-180"></i>
                                </summary>
                                <p class="text-xs mt-2 text-gray-400">Yes. The layout follows standard competitive patterns (Roll No, Booklet Series, Matrix Grid). Customization allows up to 200 questions.</p>
                            </details>
                            <details class="bg-cyber-panel border border-cyber-border rounded p-3 group">
                                <summary class="cursor-pointer font-bold text-white flex justify-between">
                                    Why is the background Red/Pink? <i class="fa-solid fa-chevron-down group-open:rotate-180"></i>
                                </summary>
                                <p class="text-xs mt-2 text-gray-400">This is the industry standard "blind color." OMR sensors often use red LEDs. Red ink reflects red light, appearing white to the sensor, while pencil marks absorb it, appearing black. This increases accuracy.</p>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 pt-8 border-t border-cyber-border text-center text-xs text-gray-600 font-mono">
                ENGINE: V4.1.2-STABLE | RENDER: VECTOR-DOM | STATUS: OPERATIONAL
            </div>
        </div>
    </section>

    <script>
        /**
         * OMR COMMANDER ENGINE
         * Modular architecture for reliability.
         */
        const app = {
            config: {
                scale: 1,
                paperWidth: 210, // mm
            },

            // --- INITIALIZATION ---
            init() {
                // Attach Event Listeners
                document.querySelectorAll('input, select').forEach(el => {
                    if(el.type !== 'file') el.addEventListener('input', () => this.debounceRender());
                });
                
                document.getElementById('checkLogo').addEventListener('change', this.render);
                document.getElementById('checkBooklet').addEventListener('change', this.render);
                document.getElementById('inpLogo').addEventListener('change', this.handleLogoUpload);
                
                window.addEventListener('resize', this.autoZoom);

                // Initial Render
                this.render();
                setTimeout(() => this.autoZoom(), 100);
            },

            debounceTimer: null,
            debounceRender() {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => this.render(), 300);
            },

            // --- RENDER LOGIC ---
            render() {
                console.log("System: Rendering Sheet...");
                
                // 1. Header Text
                document.getElementById('outInst').innerText = document.getElementById('inpInstitute').value || "INSTITUTE NAME";
                document.getElementById('outExam').innerText = document.getElementById('inpExam').value || "EXAM NAME";

                // 2. Logo Logic
                const showLogo = document.getElementById('checkLogo').checked;
                const logoContainer = document.getElementById('logoContainer');
                if(!showLogo) logoContainer.classList.add('opacity-0');
                else logoContainer.classList.remove('opacity-0');

                // 3. Roll Number Engine
                const rollDigits = parseInt(document.getElementById('inpRollDig').value);
                this.renderBubbleBlock('rollInputs', 'rollBubbles', rollDigits);

                // 4. Booklet Engine
                const showBooklet = document.getElementById('checkBooklet').checked;
                const bookletSection = document.getElementById('bookletSection');
                
                if(showBooklet) {
                    bookletSection.style.display = 'flex';
                    const bookletDigits = parseInt(document.getElementById('inpBookletDig').value);
                    this.renderBubbleBlock('bookletInputs', 'bookletBubbles', bookletDigits, true); // True = Black bubbles for Booklet
                } else {
                    bookletSection.style.display = 'none';
                }

                // 5. Questions Grid Engine
                this.renderQuestions();

                // 6. Machine Codes
                this.renderCodes();

                // 7. Timing Tracks
                this.renderTimingTracks();
            },

            // Helper for Number Blocks (Roll No / Booklet)
            renderBubbleBlock(inputId, bubbleId, digits, isBlack = false) {
                const iCont = document.getElementById(inputId);
                const bCont = document.getElementById(bubbleId);
                iCont.innerHTML = '';
                bCont.innerHTML = '';

                const borderColor = isBlack ? 'black' : 'var(--dropout-color)';
                const bubbleColor = isBlack ? 'black' : 'var(--dropout-color)';
                const bubbleClass = isBlack ? 'text-black border-black' : 'text-[var(--dropout-color)] border-[var(--dropout-color)]';

                for(let i=0; i<digits; i++){
                    // Input Box
                    const box = document.createElement('div');
                    box.className = 'omr-box';
                    box.style.borderColor = borderColor;
                    iCont.appendChild(box);

                    // Bubble Column
                    const col = document.createElement('div');
                    col.className = 'flex flex-col gap-[1px] items-center';
                    col.style.width = '14px';
                    
                    let html = '';
                    for(let d=0; d<=9; d++) {
                        html += `<div class="omr-bubble ${bubbleClass}" style="width:10px; height:10px; font-size:6px;">${d}</div>`;
                    }
                    col.innerHTML = html;
                    bCont.appendChild(col);
                }
            },

            renderQuestions() {
                const totalQ = parseInt(document.getElementById('inpTotalQ').value);
                const cols = parseInt(document.getElementById('inpCols').value);
                const opts = parseInt(document.getElementById('inpOpts').value);
                const grid = document.getElementById('qGrid');

                grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                grid.innerHTML = '';

                const qPerCol = Math.ceil(totalQ / cols);
                const letters = ['A','B','C','D','E'];

                for(let c=0; c<cols; c++) {
                    const colDiv = document.createElement('div');
                    colDiv.className = 'q-col';
                    
                    for(let i=0; i<qPerCol; i++) {
                        const qNum = (c * qPerCol) + i + 1;
                        if(qNum > totalQ) break;

                        const row = document.createElement('div');
                        row.className = 'q-row';
                        
                        let bubbles = '';
                        for(let o=0; o<opts; o++) {
                            bubbles += `<div class="omr-bubble">${letters[o]}</div>`;
                        }
                        
                        // Add spacing every 5 questions for readability
                        const mb = (qNum % 5 === 0) ? 'mb-2' : '';
                        if(mb) row.classList.add('mb-1.5');

                        row.innerHTML = `<div class="q-idx">${qNum}</div><div class="flex gap-1">${bubbles}</div>`;
                        colDiv.appendChild(row);
                    }
                    grid.appendChild(colDiv);
                }
            },

            renderTimingTracks() {
                const track = document.getElementById('timingTrack');
                track.innerHTML = '';
                // Calculate roughly needed marks
                const height = track.offsetHeight;
                const count = Math.floor(height / 10); // Spacing
                for(let i=0; i<count; i++) {
                    const dash = document.createElement('div');
                    dash.className = 'track-dash';
                    track.appendChild(dash);
                }
            },

            renderCodes() {
                // QR
                const qrCont = document.getElementById('qrCode');
                qrCont.innerHTML = '';
                const qrText = document.getElementById('inpQrData').value || `OMR-${Date.now()}`;
                new QRCode(qrCont, {
                    text: qrText,
                    width: 60, height: 60,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                // Barcode
                const barText = document.getElementById('inpBarData').value || `BATCH-${Date.now().toString().slice(-6)}`;
                JsBarcode("#barcode", barText, {
                    format: "CODE128",
                    width: 1.2,
                    height: 25,
                    displayValue: false,
                    margin: 0
                });
            },

            handleLogoUpload(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = document.getElementById('renderLogo');
                        img.src = ev.target.result;
                        img.classList.remove('hidden');
                        img.previousElementSibling.classList.add('hidden'); // Hide text placeholder
                    }
                    reader.readAsDataURL(file);
                }
            },

            // --- VIEWPORT ENGINE ---
            autoZoom() {
                const wrapper = document.getElementById('paperWrapper');
                const container = document.getElementById('scrollContainer');
                if(!wrapper || !container) return;

                const pad = 60;
                const availW = container.offsetWidth - pad;
                const paperW = wrapper.offsetWidth; // ~793px for A4 @ 96dpi

                let scale = 1;
                if(availW < paperW) {
                    scale = availW / paperW;
                }
                
                this.applyZoom(scale);
            },

            zoom(delta) {
                let currentScale = this.config.scale;
                currentScale += delta;
                if(currentScale < 0.3) currentScale = 0.3;
                if(currentScale > 1.5) currentScale = 1.5;
                this.applyZoom(currentScale);
            },

            applyZoom(s) {
                this.config.scale = s;
                const wrapper = document.getElementById('paperWrapper');
                wrapper.style.transform = `scale(${s})`;
                // Adjust margin bottom to prevent whitespace when zooming out
                wrapper.style.marginBottom = `-${(1-s)*100}%`;
                document.getElementById('lblZoom').innerText = Math.round(s*100) + '%';
            },

            // --- EXPORT ENGINE ---
            download() {
                const btn = document.querySelector('button[onclick="app.download()"]');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-gear fa-spin"></i> PROCESSING...';
                
                const element = document.getElementById('sheet');
                const wrapper = document.getElementById('paperWrapper');
                
                // 1. Reset Scale for crisp PDF
                const currentTransform = wrapper.style.transform;
                const currentMargin = wrapper.style.marginBottom;
                wrapper.style.transform = 'scale(1)';
                wrapper.style.marginBottom = '0';
                wrapper.style.margin = '0';

                // 2. Hide Borders/UI for PDF
                // (Handled by CSS @media print, but html2pdf uses canvas)
                
                const opt = {
                    margin: 0,
                    filename: `OMR_${document.getElementById('inpExam').value.replace(/\s+/g,'_')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 3, useCORS: true, logging: false, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    // Restore UI
                    wrapper.style.transform = currentTransform;
                    wrapper.style.marginBottom = currentMargin;
                    wrapper.style.margin = ''; // Reset
                    btn.innerHTML = originalHtml;
                });
            }
        };

        // Boot
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
