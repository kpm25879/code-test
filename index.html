<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* =========================================
       2. CSS STYLESHEET
    ========================================= */
    
    /* Scoped Container to protect against WP Theme styles */
    #tys-app-container {
        font-family: 'Segoe UI', sans-serif;
        background-color: #eef2f5;
        color: #333;
        width: 100%;
        padding: 40px 20px;
        box-sizing: border-box;
        border-radius: 8px;
        margin: 20px 0;
    }

    #tys-app-container * {
        box-sizing: border-box;
    }

    /* --- Typography & Headings --- */
    #tys-app-container h2.tys-title {
        color: #002347; /* Navy */
        text-align: center;
        font-family: 'Montserrat', sans-serif;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -1px;
        margin: 0 0 10px 0;
        font-size: 32px;
        text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
    }

    #tys-app-container p.tys-subtitle {
        color: #666;
        margin-bottom: 40px;
        font-weight: 600;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 14px;
    }

    /* --- Search Control Panel --- */
    .tys-controls {
        background: #ffffff;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 500px;
        margin: 0 auto 50px auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        border-top: 6px solid #FF9933; /* Saffron */
    }

    .tys-input-group {
        position: relative;
        width: 100%;
    }

    .tys-input-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #002347;
        font-size: 18px;
        z-index: 2;
    }

    .tys-input {
        width: 100%;
        padding: 16px 16px 16px 50px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        color: #333;
        background: #f9f9f9;
        outline: none;
        transition: all 0.3s ease;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
    }

    .tys-input:focus {
        border-color: #FF9933;
        background: #ffffff;
        box-shadow: 0 0 0 4px rgba(255, 153, 51, 0.1);
    }

    .tys-btn-verify {
        background: linear-gradient(135deg, #002347 0%, #00152e 100%);
        color: white;
        border: none;
        padding: 18px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 16px;
        width: 100%;
        transition: all 0.3s ease;
        letter-spacing: 1px;
        box-shadow: 0 10px 20px rgba(0, 35, 71, 0.2);
    }

    .tys-btn-verify:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(0, 35, 71, 0.3);
    }

    #tys-status-msg {
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        color: #555;
        min-height: 24px;
        margin-top: 10px;
    }

    /* --- Result Grid Area --- */
    #tys-results {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 50px;
        align-items: center;
    }

    .tys-card-row {
        display: flex;
        gap: 60px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        background: #ffffff;
        padding: 50px;
        border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.05);
        animation: tysFadeIn 0.5s ease-in;
        width: 100%;
        max-width: 1200px;
    }

    @keyframes tysFadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .tys-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .tys-label {
        font-weight: 800;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 12px;
    }

    /* --- ID Card Container (Visual Wrapper) --- */
    .tys-card-wrapper {
        width: 54mm;
        height: 86mm;
        position: relative;
        background: transparent;
        box-shadow: 0 15px 35px rgba(0,0,0,0.25);
        border-radius: 3.18mm;
        transition: transform 0.3s ease;
    }

    .tys-card-wrapper:hover {
        transform: scale(1.03);
        z-index: 10;
    }

    /* --- THE ID CARD (Actual Design) --- */
    /* This class is used for both Display and Print generation */
    .id-card-body {
        width: 54mm;
        height: 86mm;
        background: #ffffff;
        position: relative;
        overflow: hidden;
        border-radius: 3.18mm;
        font-family: 'Montserrat', sans-serif;
        /* Visible Boundary Line */
        border: 1px solid #000; 
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }

    /* --- FRONT DESIGN --- */
    .front-header {
        height: 18%;
        background: #002347; /* Navy */
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2mm 0 3mm;
        position: relative;
        z-index: 5;
        /* Diagonal Cut */
        clip-path: polygon(0 0, 100% 0, 100% 88%, 0 100%);
        border-bottom: 2px solid #FF9933; /* Saffron */
    }
    
    /* Saffron Accent Line */
    .front-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: #FF9933;
        z-index: 6;
    }

    .header-logo {
        width: 8.5mm;
        height: auto;
        margin-right: 1.5mm;
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }

    .header-title {
        color: white;
        font-family: 'Oswald', sans-serif;
        font-size: 7.5pt;
        line-height: 1.1;
        font-weight: 700;
        text-transform: uppercase;
        text-align: left;
    }

    .header-qr {
        width: 9mm;
        height: 9mm;
        background: white;
        padding: 1px;
        border-radius: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 2mm;
        margin-right: 1mm;
    }
    .header-qr img { width: 100%; height: 100%; }

    .front-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 3mm;
        position: relative;
        /* Security Mesh Pattern */
        background-image: 
            linear-gradient(#f4f4f4 1px, transparent 1px),
            linear-gradient(90deg, #f4f4f4 1px, transparent 1px);
        background-size: 4mm 4mm;
        padding-bottom: 6mm;
    }

    .photo-container {
        width: 21mm;
        height: 25mm;
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 2mm;
        object-fit: cover;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .name-display {
        font-size: 10pt;
        font-weight: 900;
        color: #002347;
        text-transform: uppercase;
        text-align: center;
        line-height: 1.1;
        width: 95%;
        margin-bottom: 1px;
    }

    .role-badge {
        background: #FF9933;
        color: white;
        font-size: 5pt;
        font-weight: 700;
        padding: 1.5px 8px;
        border-radius: 0px;
        text-transform: uppercase;
        margin-bottom: 2mm;
        clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
    }

    .details-grid {
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 1px;
        margin-bottom: auto;
    }

    .d-row {
        display: flex;
        font-size: 6pt;
        border-bottom: 1px dashed #eee;
        padding-bottom: 1px;
        align-items: center;
    }

    .d-key {
        width: 40%;
        color: #666;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 5pt;
        letter-spacing: 0.2px;
    }

    .d-val {
        width: 60%;
        color: #000;
        font-weight: 800;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .barcode-wrapper {
        position: absolute;
        bottom: 6mm;
        left: 50%;
        transform: translateX(-50%);
        height: 8mm;
        width: 90%;
        display: flex;
        justify-content: center;
        z-index: 2;
    }
    .barcode-wrapper svg { width: 100%; height: 100%; }

    .front-footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 5mm;
        background: #002347;
        border-top: 1px solid #FF9933;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #FF9933;
        font-size: 5pt;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        z-index: 5;
    }

    /* --- BACK DESIGN --- */
    .back-header {
        height: 12%;
        background: #002347;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 800;
        font-size: 7.5pt;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 2px solid #FF9933;
    }

    .back-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 3mm;
        position: relative;
    }

    .back-logo {
        width: 16mm;
        margin-top: 1mm;
        opacity: 1;
    }

    .back-org-title {
        font-size: 8pt;
        font-weight: 900;
        color: #002347;
        text-transform: uppercase;
        margin: 1mm 0 2mm 0;
        width: 90%;
        text-align: center;
        padding-bottom: 1mm;
        border-bottom: 1px solid #eee;
    }

    .qr-title {
        font-size: 5pt;
        font-weight: 800;
        color: #FF9933;
        margin-bottom: 1px;
        text-transform: uppercase;
    }

    .qr-box {
        width: 14mm;
        height: 14mm;
        border: 1px solid #ddd;
        padding: 1px;
        margin-bottom: 3mm;
        background: white;
    }
    .qr-box img { width: 100%; height: 100%; }

    .info-box {
        width: 100%;
        margin-bottom: 2mm;
        margin-top: 1mm;
    }

    .info-row {
        display: flex;
        gap: 2mm;
        margin-bottom: 1.5mm;
        align-items: flex-start;
    }

    .info-icon {
        color: #FF9933;
        font-size: 6pt;
        width: 3mm;
        text-align: center;
        margin-top: 1px;
    }

    .info-text {
        font-size: 5pt;
        font-weight: 600;
        color: #444;
        flex: 1;
        line-height: 1.2;
        text-align: left;
    }

    .terms-section {
        width: 100%;
        margin-top: auto;
        /* Critical Gap for Signatory */
        margin-bottom: 12mm; 
    }

    .terms-head {
        margin: 0;
        font-size: 4pt;
        color: #002347;
        text-transform: uppercase;
        text-align: left;
        font-weight: 800;
    }

    .terms-body {
        margin: 0;
        font-size: 3.5pt;
        color: #666;
        line-height: 1.1;
        text-align: left;
        margin-top: 1px;
    }

    /* AUTHORIZED SIGNATORY SECTION */
    .signatory-area {
        position: absolute;
        bottom: 6mm;
        right: 4mm;
        text-align: center;
        z-index: 5;
    }

    .sign-line {
        width: 22mm;
        height: 1px;
        background: #000;
        margin-bottom: 1px;
    }

    .sign-text {
        font-size: 4pt;
        font-weight: 800;
        color: #002347;
        text-transform: uppercase;
    }

    .stamp-overlay {
        position: absolute;
        bottom: 2mm;
        right: 0;
        width: 20mm;
        opacity: 0.85;
        mix-blend-mode: multiply;
        transform: rotate(-15deg);
        pointer-events: none;
        z-index: 10;
    }

    .back-footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 5mm;
        background: #138808; /* Green */
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 4.5pt;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* --- ACTION BUTTONS --- */
    .tys-btn-group {
        display: flex;
        gap: 20px;
        flex-direction: column;
        justify-content: center;
        width: 100%;
        max-width: 300px;
    }

    .tys-tool-btn {
        border: none;
        padding: 20px 25px;
        border-radius: 12px;
        cursor: pointer;
        color: white;
        font-weight: 800;
        font-size: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        width: 100%;
        transition: 0.3s;
        text-transform: uppercase;
    }

    .btn-print {
        background: linear-gradient(135deg, #FF9933, #e67e22);
        box-shadow: 0 8px 15px rgba(255, 153, 51, 0.3);
    }
    .btn-print:hover { transform: translateY(-3px); box-shadow: 0 12px 20px rgba(255, 153, 51, 0.4); }

    .btn-download {
        background: linear-gradient(135deg, #2980b9, #2c3e50);
        box-shadow: 0 8px 15px rgba(41, 128, 185, 0.3);
    }
    .btn-download:hover { transform: translateY(-3px); box-shadow: 0 12px 20px rgba(41, 128, 185, 0.4); }

    /* --- RESPONSIVE FIXES --- */
    @media (max-width: 768px) {
        .tys-card-row { flex-direction: column; padding: 20px; gap: 40px; }
        .tys-btn-group { flex-direction: row; max-width: 100%; }
        .tys-tool-btn { font-size: 12px; padding: 15px; }
    }
</style>

<div id="tys-app-container">
    
    <div class="tys-controls">
        <h2 class="tys-title">ID Card Verification</h2>
        <p class="tys-subtitle">Official Database Access</p>
        
        <div class="tys-input-group">
            <i class="fa-solid fa-id-badge tys-input-icon"></i>
            <input type="text" id="inputId" class="tys-input" placeholder="Member ID (e.g. YM-101)">
        </div>
        
        <div class="tys-input-group">
            <i class="fa-solid fa-phone tys-input-icon"></i>
            <input type="text" id="inputPhone" class="tys-input" placeholder="Registered Phone">
        </div>
        
        <button class="tys-btn-verify" onclick="verifyAndSearch()">Verify & Generate</button>
        <div id="tys-status-msg">System Ready. Waiting for credentials...</div>
    </div>

    <div id="tys-results"></div>

</div>

<script>
    // --- CONFIGURATION ---
    const DB_URL = "https://docs.google.com/spreadsheets/d/1p1ynKWyRErPwczTcMkffZfQ7dhOiV9buv_gIVRK3uh0/export?format=csv&gid=85144492";
    
    const ASSETS = {
        org: "Tiranga Yuva Samiti",
        logo: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCaJCRPLvQgi9REoAvb9b4H4Vvh6RhAmMRGwGEolXIqS2nxxCa9-jS7qexF2JL5puwPOEk-2q7ubDKeL-m-BM0_7_uHrI5EnBXue7deGtgta4UyCDnI43AkB1KBN8PV4G00fg1vW2La338AyzZkHvXpzt49papqeYLt9NDXMcTnvsceg/s1600/TYS-White.png",
        stamp: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEif3QsddJJfS7s0DWat3m-JGugl9Jf3PHlxuPenO9wCWmjqiqV2UZ2IBMA_0b2ID8Uk1Ukwozo206pIjMGCEm5rK6e24u33ZDaSUUvnVzfsMQX6aY4BoleEeCGB3PMBfh4VER_I5Qsac0CHXkwtvVu5kuefZWrr9qr5MEOPyL8_tpkKow/s1600/Naveen%20Stamp.jpg",
        donate: "https://www.tirangayuvasamiti.org/donate/",
        contact: {
            addr: "VPO Khanda 9R, Tehsil Kharkhoda, Sonipat, Haryana – 131402",
            ph: "+91 90535 75169",
            em: "info@tirangayuvasamiti.org",
            wb: "www.tirangayuvasamiti.org"
        }
    };

    let MEM_DB = [];

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', loadDatabase);

    async function loadDatabase() {
        const msg = document.getElementById('tys-status-msg');
        msg.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Connecting to Secure Server...';
        try {
            const res = await fetch(DB_URL + "&t=" + Date.now());
            const buf = await res.arrayBuffer();
            const wb = XLSX.read(new Uint8Array(buf), {type:'array', cellDates:true});
            MEM_DB = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            msg.innerHTML = MEM_DB.length ? `<span style="color:#138808">✅ Database Active (${MEM_DB.length} Records)</span>` : "Database Empty";
        } catch(e) { msg.innerHTML = `<span style="color:#e74c3c">❌ Connection Failed. Check Internet.</span>`; }
    }

    // --- SEARCH ---
    function verifyAndSearch() {
        const id = document.getElementById('inputId').value.trim().toLowerCase();
        const ph = document.getElementById('inputPhone').value.trim().toLowerCase();
        const msg = document.getElementById('tys-status-msg');
        const grid = document.getElementById('tys-results');
        grid.innerHTML = "";

        if(!id || !ph) { msg.innerText = "⚠ Please provide both credentials."; return; }

        msg.innerHTML = "Authenticating...";
        const found = MEM_DB.filter(m => 
            String(m.id).toLowerCase().includes(id) && String(m.phone).toLowerCase().includes(ph)
        );

        if(!found.length) { 
            msg.innerHTML = `<span style="color:#e74c3c">❌ Verification Failed: Invalid Credentials.</span>`; 
        } else {
            msg.innerHTML = `<span style="color:#138808">✅ Identity Verified. Generating Card...</span>`;
            renderCard(found[0]);
        }
    }

    // --- RENDER ---
    function renderCard(data) {
        const grid = document.getElementById('tys-results');
        
        // Data Mapping
        const fName = (data.firstname || '').trim();
        const lName = (data.lastname || '').trim();
        const fullName = `${fName} ${lName}`;
        const father = data.father_name || '________';
        const memId = data.id || '000';
        const phone = data.phone || '________';
        const role = data.membership || 'Member';
        const joined = formatDate(data.joined);
        const photoUrl = data.photo_url || 'https://via.placeholder.com/150';
        
        // Slug
        let slug = fName;
        if(lName) slug += " " + lName;
        slug = slug.toLowerCase().replace(/[^a-z0-9]/g, '-');
        const qrUrl = `https://www.tirangayuvasamiti.org/tiranga-yuva-members/${slug}/`;

        const uId = Date.now();
        
        const html = `
        <div class="tys-card-row">
            <div class="tys-col">
                <div class="tys-label">Front Side</div>
                <div class="tys-card-wrapper" id="front-${uId}">
                    <div class="id-card-body">
                        <div class="front-header">
                            <div style="display:flex; align-items:center;">
                                <img src="${ASSETS.logo}" class="header-logo" crossorigin="anonymous">
                                <div class="header-title">${ASSETS.org}</div>
                            </div>
                            <div class="header-qr" id="qr-head-${uId}"></div>
                        </div>
                        <div class="front-main">
                            <img src="${photoUrl}" class="photo-container" crossorigin="anonymous">
                            <div class="name-display">${fullName}</div>
                            <div class="role-badge">${role} Member</div>
                            
                            <div class="details-grid">
                                <div class="d-row"><div class="d-key">FATHER'S NAME</div><div class="d-val">${father}</div></div>
                                <div class="d-row"><div class="d-key">MEMBER ID</div><div class="d-val">TYS-${memId}</div></div>
                                <div class="d-row"><div class="d-key">CONTACT</div><div class="d-val">${phone}</div></div>
                                <div class="d-row"><div class="d-key">ISSUED ON</div><div class="d-val">${joined}</div></div>
                            </div>
                            
                            <div class="barcode-wrapper"><svg id="bar-${uId}"></svg></div>
                        </div>
                        <div class="front-footer">${ASSETS.org}</div>
                    </div>
                </div>
            </div>

            <div class="tys-col">
                <div class="tys-label">Back Side</div>
                <div class="tys-card-wrapper" id="back-${uId}">
                    <div class="id-card-body">
                        <div class="back-header">OFFICIAL IDENTIFICATION</div>
                        <div class="back-main">
                            <img src="${ASSETS.logo}" class="back-logo" crossorigin="anonymous">
                            <div class="back-org-title">${ASSETS.org}</div>
                            
                            <div class="qr-title">SCAN TO VERIFY MEMBER</div>
                            <div class="qr-box" id="qr-back-${uId}"></div>

                            <div class="info-box">
                                <div class="info-row"><div class="info-icon"><i class="fa-solid fa-location-dot"></i></div><div class="info-text">${ASSETS.contact.addr}</div></div>
                                <div class="info-row"><div class="info-icon"><i class="fa-solid fa-phone"></i></div><div class="info-text">${ASSETS.contact.ph}</div></div>
                                <div class="info-row"><div class="info-icon"><i class="fa-solid fa-envelope"></i></div><div class="info-text">${ASSETS.contact.em}</div></div>
                                <div class="info-row"><div class="info-icon"><i class="fa-solid fa-globe"></i></div><div class="info-text">${ASSETS.contact.wb}</div></div>
                            </div>

                            <div class="terms-section">
                                <div class="terms-head">Terms & Conditions:</div>
                                <div class="terms-body">
                                    1. This card is non-transferable property of the organization.<br>2. If found, return to the address above.
                                </div>
                            </div>

                            <div class="signatory-area">
                                <div class="sign-line"></div>
                                <div class="sign-text">AUTHORIZED SIGNATORY</div>
                                <img src="${ASSETS.stamp}" class="stamp-overlay" crossorigin="anonymous">
                            </div>
                        </div>
                        <div class="back-footer">Together We Serve • Jai Hind</div>
                    </div>
                </div>
            </div>

            <div class="tys-btn-group">
                <button class="tys-tool-btn btn-print" onclick="printCards('front-${uId}', 'back-${uId}')">
                    <i class="fa-solid fa-print" style="font-size:24px;"></i> PRINT CARD
                </button>
                <button class="tys-tool-btn btn-download" onclick="downloadImages('front-${uId}', 'back-${uId}', '${fullName}')">
                    <i class="fa-solid fa-download" style="font-size:24px;"></i> DOWNLOAD PNG
                </button>
            </div>
        </div>`;

        grid.innerHTML = html;

        // Async Generate Codes
        setTimeout(() => {
            const q1 = document.getElementById(`qr-head-${uId}`);
            new QRCode(q1, { text: ASSETS.donate, width: 64, height: 64, correctLevel: QRCode.CorrectLevel.L });
            fixCanvas(q1);

            const q2 = document.getElementById(`qr-back-${uId}`);
            new QRCode(q2, { text: qrUrl, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
            fixCanvas(q2);

            JsBarcode(`#bar-${uId}`, `TYS-${memId}`, {
                format:"CODE128", displayValue:false, height:30, margin:0, background:"transparent", width:1.5
            });
        }, 100);
    }

    function fixCanvas(container) {
        setTimeout(() => {
            const canvas = container.querySelector('canvas');
            if(canvas) {
                const img = document.createElement('img');
                img.src = canvas.toDataURL("image/png");
                img.style.width = '100%'; img.style.height = '100%';
                container.innerHTML = '';
                container.appendChild(img);
            }
        }, 50);
    }

    function formatDate(raw) {
        if(!raw) return '________';
        let d = new Date(raw);
        if(isNaN(d.getTime())) return raw;
        return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
    }

    // --- PRINT FUNCTION (CENTERED & UNCUT) ---
    function printCards(fid, bid) {
        const fHtml = document.getElementById(fid).innerHTML;
        const bHtml = document.getElementById(bid).innerHTML;
        
        const win = window.open('', '', 'width=900,height=700');
        win.document.write(`
            <html><head><title>Print ID Card</title>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
                @page { size: auto; margin: 0; }
                body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                
                .print-page { 
                    width: 100vw; height: 100vh; 
                    display: flex; justify-content: center; align-items: center; 
                    page-break-after: always; 
                }

                * { box-sizing: border-box; }
                /* CARD DIMENSIONS */
                .id-card-body { 
                    width: 54mm; height: 86mm; 
                    background: #fff; position: relative; overflow: hidden; 
                    border-radius: 3.18mm; font-family: 'Montserrat', sans-serif; 
                    border: 1px solid #000; box-sizing: border-box; display: flex; flex-direction: column;
                }

                /* FRONT CSS */
                .front-header { height: 18%; background: #002347; display: flex; align-items: center; justify-content: space-between; padding: 0 2mm 0 3mm; clip-path: polygon(0 0, 100% 0, 100% 88%, 0 100%); border-bottom: 2px solid #FF9933; position: relative; z-index: 5; }
                .front-header:after { content:''; position:absolute; bottom:0; left:0; width:100%; height:2px; background:#FF9933; z-index:6; }
                .header-logo { width: 8.5mm; margin-right: 1.5mm; }
                .header-title { font-size: 7.5pt; font-weight: 800; color: white; text-transform: uppercase; text-align: left; font-family: 'Oswald', sans-serif; line-height: 1.1; }
                .header-qr-box { width: 9mm; height: 9mm; background: white; padding: 1px; display: flex; align-items: center; justify-content: center; margin-bottom: 2mm; margin-right: 1mm; }
                .header-qr-box img { width: 100%; height: 100%; }
                
                .front-main { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 2mm; background-image: linear-gradient(#f4f4f4 1px, transparent 1px), linear-gradient(90deg, #f4f4f4 1px, transparent 1px); background-size: 4mm 4mm; padding-bottom: 6mm; }
                .photo-container { width: 21mm; height: 25mm; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 2mm; object-fit: cover; }
                .name-display { font-size: 10pt; font-weight: 900; color: #002347; text-transform: uppercase; text-align: center; line-height: 1.1; width: 95%; margin-bottom: 1px; }
                .role-badge { background: #FF9933; color: white; font-size: 5pt; font-weight: 700; padding: 1.5px 8px; text-transform: uppercase; margin-bottom: 2mm; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%); }
                
                .details-grid { width: 90%; display: flex; flex-direction: column; gap: 1px; margin-bottom: auto; }
                .d-row { display: flex; align-items: center; margin-bottom: 1px; border-bottom: 1px solid #eee; padding: 1.5px 0; }
                .d-key { width: 40%; font-weight: 700; color: #666; font-size: 5pt; text-transform: uppercase; }
                .d-val { width: 60%; font-weight: 800; color: #000; text-align: right; font-size: 6pt; }
                
                .barcode-wrapper { position: absolute; bottom: 6mm; left: 50%; transform: translateX(-50%); height: 8mm; width: 90%; display: flex; justify-content: center; }
                .barcode-wrapper svg { width: 100%; height: 100%; }
                .front-footer { position: absolute; bottom: 0; width: 100%; height: 5mm; background: #002347; display: flex; align-items: center; justify-content: center; color: #FF9933; font-size: 5pt; font-weight: 800; text-transform: uppercase; border-top: 1px solid #FF9933; }

                /* BACK CSS */
                .back-header { height: 12%; background: #002347; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 7.5pt; text-transform: uppercase; border-bottom: 2px solid #FF9933; }
                .back-main { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 3mm; text-align: center; position: relative; background: #fff; }
                .back-logo { width: 16mm; margin-top: 1mm; }
                .back-org-title { font-size: 8pt; font-weight: 900; color: #002347; text-transform: uppercase; margin: 1mm 0 2mm 0; width: 90%; }
                .qr-title { font-size: 5pt; font-weight: 800; color: #FF9933; margin-bottom: 1px; text-transform: uppercase; }
                .qr-box { width: 14mm; height: 14mm; border: 1px solid #ddd; padding: 1px; margin-bottom: 3mm; }
                .qr-box img { width: 100%; height: 100%; }
                .info-box { width: 100%; text-align: left; margin-top: 1mm; }
                .info-row { display: flex; gap: 2mm; margin-bottom: 1.5mm; }
                .info-icon { color: #FF9933; font-size: 6pt; width: 3mm; text-align: center; }
                .info-text { font-size: 5pt; font-weight: 600; color: #444; flex: 1; text-align: left; }
                
                .terms-section { width: 100%; margin-top: auto; margin-bottom: 12mm; }
                .terms-head { font-size: 4pt; font-weight: 800; color: #002347; text-transform: uppercase; text-align: left; }
                .terms-body { font-size: 3.5pt; color: #666; text-align: left; line-height: 1.1; margin-top: 1px; }
                
                .signatory-area { position: absolute; bottom: 6mm; right: 4mm; text-align: center; z-index: 5; }
                .sign-line { width: 22mm; height: 1px; background: #000; margin-bottom: 1px; }
                .sign-text { font-size: 4pt; font-weight: 800; color: #002347; text-transform: uppercase; }
                .stamp-overlay { position: absolute; bottom: 2mm; right: 0; width: 20mm; opacity: 0.85; mix-blend-mode: multiply; transform: rotate(-15deg); z-index: 10; }
                
                .back-footer { position: absolute; bottom: 0; width: 100%; height: 5mm; background: #138808; display: flex; align-items: center; justify-content: center; color: white; font-size: 4.5pt; font-weight: 600; text-transform: uppercase; }
            </style>
            </head><body>
                <div class="print-page">${fHtml}</div>
                <div class="print-page">${bHtml}</div>
            </body></html>
        `);
        win.document.close();
        setTimeout(() => { win.focus(); win.print(); }, 1000);
    }

    // --- DOWNLOAD FUNCTION (HIGH RES) ---
    async function downloadImages(fid, bid, name) {
        const cleanName = name.replace(/[^a-zA-Z0-9]/g, '_');
        const config = { scale: 4, useCORS: true, allowTaint: true, backgroundColor: null };

        const fEl = document.querySelector(`#${fid} .id-card-body`);
        const c1 = await html2canvas(fEl, config);
        saveAs(c1.toDataURL("image/png"), `TYS_${cleanName}_FRONT.png`);

        setTimeout(async () => {
            const bEl = document.querySelector(`#${bid} .id-card-body`);
            const c2 = await html2canvas(bEl, config);
            saveAs(c2.toDataURL("image/png"), `TYS_${cleanName}_BACK.png`);
        }, 1000);
    }

    function saveAs(uri, filename) {
        const link = document.createElement("a");
        link.download = filename;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
