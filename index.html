<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
    if (!document.querySelector('meta[name="viewport"]')) {
        const meta = document.createElement('meta');
        meta.name = "viewport";
        meta.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no";
        document.getElementsByTagName('head')[0].appendChild(meta);
    }
</script>

<style>
    /* === GLOBAL FLUID LAYOUT === */
    html, body { 
        margin: 0; 
        padding: 0; 
        width: 100%; 
        overflow-x: hidden; 
        background-color: #ffffff; 
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;
    }

    #tys-wrapper {
        font-family: 'Segoe UI', sans-serif;
        background: #ffffff;
        padding: 0;
        margin: 0;
        width: 100%;
        min-height: 100vh;
        color: #333;
        line-height: 1.6;
        box-sizing: border-box;
    }
    #tys-wrapper * { box-sizing: border-box; }

    /* === MAIN CONTAINER === */
    #tys-wrapper .app-box {
        width: 100%;
        max-width: 100%;
        margin: 0;
        background: transparent;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #tys-wrapper h2 {
        margin-top: 10px; color: #2c3e50; margin-bottom: 5px; text-align: center;
        font-weight: 700; font-family: 'Montserrat', sans-serif; font-size: 26px;
        width: 100%;
    }

    #tys-wrapper p.desc { color: #666; margin-bottom: 25px; text-align: center; font-size: 15px; width: 100%; }

    /* === SEARCH INPUTS AREA === */
    #tys-wrapper .controls {
        background: #2c3e50; 
        padding: 20px; 
        border-radius: 8px; 
        color: white;
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
        align-items: center;
        border-bottom: 4px solid #FF9933; /* Saffron Accent */
        margin-bottom: 40px;
        width: 100%; 
        max-width: 600px;
    }

    #tys-wrapper .input-group { width: 100%; position: relative; }
      
    #tys-wrapper .input-icon {
        position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
        color: #777; z-index: 2; font-size: 16px;
    }

    #tys-wrapper .secure-input {
        width: 100%; padding: 14px 15px 14px 45px; 
        border: none; border-radius: 4px;
        font-size: 16px; color: #333; background: #f8f9fa; border: 2px solid transparent;
        transition: 0.3s; height: auto;
        -webkit-appearance: none;
    }
    #tys-wrapper .secure-input:focus { outline: none; border-color: #FF9933; background: white; }

    #tys-wrapper .btn-verify {
        background: #FF9933; color: white; border: none; padding: 14px 30px;
        border-radius: 4px; cursor: pointer; font-weight: 700; text-transform: uppercase;
        font-size: 16px; width: 100%; transition: 0.2s; margin-top: 5px;
    }
    #tys-wrapper .btn-verify:hover { background: #d35400; transform: translateY(-1px); }

    #tys-wrapper #status-msg { 
        font-weight: 600; font-size: 14px; color: #ecf0f1; margin-top: 5px;
        min-height: 20px; text-align: center; width: 100%;
    }

    /* === RESULT GRID === */
    #tys-wrapper #grid-area {
        display: flex; flex-direction: column; gap: 40px; align-items: center; width: 100%;
    }

    .member-row {
        display: flex; 
        gap: 40px; 
        align-items: center; 
        justify-content: center;
        background: #fdfdfd;
        padding: 20px; 
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        animation: fadeIn 0.5s ease-in-out; 
        flex-wrap: wrap; 
        width: 100%;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .preview-col { display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative; }
    .preview-label { font-size: 13px; color: #999; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }

    /* === PRINT BUTTON === */
    .print-btn {
        background: #138808; color: white; border: none; padding: 15px 25px;
        border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 700;
        display: flex; flex-direction: column; align-items: center; gap: 8px;
        box-shadow: 0 4px 10px rgba(19, 136, 8, 0.3); transition: 0.2s;
        height: 100%; min-height: 160px; justify-content: center; width: auto;
    }
    .print-btn:hover { background: #0e6b05; transform: scale(1.05); }

    /* === ID CARD WRAPPER (VERTICAL) === */
    .id-card-wrapper { 
        width: 54mm;  /* VERTICAL WIDTH */
        height: 85.6mm; /* VERTICAL HEIGHT */
        position: relative; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.15); 
        background: white;
        transition: transform 0.3s ease;
        max-width: 90vw; 
    }
     
    .id-card { 
        width: 54mm; 
        height: 85.6mm; 
        background: #fff; 
        position: relative; 
        overflow: hidden; 
        font-family: 'Montserrat', sans-serif; 
        color: #333; 
        line-height: 1; 
        display: flex;
        flex-direction: column;
    }

    /* === RESPONSIVE BREAKPOINTS === */
    @media (max-width: 992px) {
        .member-row { flex-direction: column; gap: 40px; background: transparent; border: none; padding: 0; }
        .print-btn { 
            width: 100%; max-width: 100%; min-height: auto; padding: 15px;
            flex-direction: row; justify-content: center; 
        }
        .print-btn i { font-size: 20px; }
        .print-btn span br { display: none; }
        .print-btn span:after { content: " NOW"; }
    }

    @media (max-width: 480px) {
        #tys-wrapper .app-box { padding: 15px 10px; }
        .controls { border-radius: 0; width: 100vw; margin-left: -10px; margin-right: -10px; border-radius: 0; }
        .id-card-wrapper {
            transform: scale(0.95); transform-origin: top center; margin-bottom: -5px;
        }
    }

    @media (max-width: 380px) {
        .id-card-wrapper {
            transform: scale(0.90); transform-origin: top center; margin-bottom: -20px;
        }
        h2 { font-size: 22px !important; }
    }

    /* === CARD CSS INTERNALS (VERTICAL DESIGN) === */
    
    /* --- FRONT DESIGN --- */
    .v-header {
        height: 18%;
        background: #FF9933; /* Saffron */
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 2;
        padding-top: 2px;
    }
    .v-header-logo { width: 8mm; height: auto; margin-bottom: 2px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); }
    .v-org-name { font-size: 8pt; font-weight: 800; color: white; text-transform: uppercase; text-shadow: 0 1px 2px rgba(0,0,0,0.2); margin: 0; line-height: 1.1; text-align: center; width: 90%; }
    
    .v-body {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 4mm;
    }
    
    .v-watermark-big {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 40mm;
        opacity: 0.06;
        filter: grayscale(100%);
        z-index: 0;
    }

    .v-photo-frame {
        width: 22mm;
        height: 26mm;
        border: 1.5px solid #FF9933;
        padding: 1px;
        background: white;
        border-radius: 4px;
        position: relative;
        z-index: 2;
        margin-bottom: 3mm;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .v-user-photo { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
    
    .v-name-block { text-align: center; margin-bottom: 4mm; z-index: 2; width: 90%; }
    .v-name-text { font-size: 11pt; font-weight: 800; color: #000080; text-transform: uppercase; line-height: 1.2; }
    .v-role-badge { 
        background: #000080; color: white; 
        font-size: 5pt; font-weight: 700; 
        padding: 1.5px 6px; border-radius: 10px; 
        display: inline-block; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .v-details-table { width: 85%; font-size: 6.5pt; z-index: 2; margin-bottom: auto; }
    .v-row { display: flex; margin-bottom: 2px; border-bottom: 0.5px dotted #ddd; padding-bottom: 1px; }
    .v-row:last-child { border-bottom: none; }
    .v-lbl { width: 40%; font-weight: 700; color: #666; }
    .v-val { width: 60%; font-weight: 700; color: #000; text-align: right; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    .v-qr-area { margin-bottom: 3mm; z-index: 2; }
    .v-qr-box { width: 14mm; height: 14mm; padding: 1px; background: white; border: 1px solid #ccc; }
    .v-qr-box img { width: 100%; height: 100%; }

    .v-footer {
        height: 6%;
        background: #138808; /* Green */
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 5pt;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    .v-stamp { position: absolute; top: 22mm; right: 10mm; width: 22mm; height: 11mm; transform: rotate(-25deg); opacity: 0.85; mix-blend-mode: multiply; z-index: 10; pointer-events: none; }

    /* --- BACK DESIGN --- */
    .vb-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
    .vb-header { height: 12%; background: #FF9933; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 8pt; text-transform: uppercase; }
    
    .vb-body { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 5mm; text-align: center; position: relative; }
    
    .vb-logo-faint { width: 30mm; opacity: 0.05; margin-bottom: 5mm; filter: grayscale(100%); }
    
    .vb-text-group { z-index: 2; width: 100%; }
    .vb-label { font-size: 5pt; color: #999; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .vb-ngo-name { font-size: 9pt; font-weight: 800; color: #FF9933; text-transform: uppercase; margin-bottom: 5mm; line-height: 1.2; }
    
    .vb-contact-row { display: flex; align-items: flex-start; gap: 2mm; font-size: 6pt; color: #444; margin-bottom: 3mm; text-align: left; }
    .vb-icon { color: #138808; width: 4mm; text-align: center; font-size: 7pt; }
    .vb-data { flex: 1; line-height: 1.3; }

    .vb-footer { height: auto; padding-bottom: 3mm; text-align: center; }
    .vb-disclaimer { font-size: 4pt; color: #aaa; font-style: italic; padding: 0 4mm; margin-bottom: 2mm; }
    .vb-strip { height: 4mm; background: #138808; width: 100%; }

</style>

<div id="tys-wrapper">
    <div class="app-box">
        <h2>ID Card Verification</h2>
        <p class="desc">System connects automatically. Enter <b>BOTH</b> details below.</p>

        <div class="controls">
            <div class="input-group">
                <i class="fa-solid fa-id-card input-icon"></i>
                <input type="text" id="inputId" class="secure-input" placeholder="Member ID (e.g. YM-125)">
            </div>

            <div class="input-group">
                <i class="fa-solid fa-phone input-icon"></i>
                <input type="text" id="inputPhone" class="secure-input" placeholder="Phone Number (e.g. 9053575169)">
            </div>

            <button class="btn-verify" onclick="verifyAndSearch()">
                <i class="fa-solid fa-check-circle"></i> Verify & Get Card
            </button>

            <div id="status-msg">Initializing database connection...</div>
        </div>

        <div id="grid-area"></div>
    </div>
</div>

<script>
    // === GOOGLE SHEETS LINK ===
    const EXCEL_FILE_URL = "https://docs.google.com/spreadsheets/d/1p1ynKWyRErPwczTcMkffZfQ7dhOiV9buv_gIVRK3uh0/export?format=csv&gid=85144492";

    const CONFIG = {
        ngoName: "Tiranga Yuva Samiti",
        ngoSub: "Service • Unity • Patriotism",
        logoUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCaJCRPLvQgi9REoAvb9b4H4Vvh6RhAmMRGwGEolXIqS2nxxCa9-jS7qexF2JL5puwPOEk-2q7ubDKeL-m-BM0_7_uHrI5EnBXue7deGtgta4UyCDnI43AkB1KBN8PV4G00fg1vW2La338AyzZkHvXpzt49papqeYLt9NDXMcTnvsceg/s1600/TYS-White.png",
        stampUrl: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEif3QsddJJfS7s0DWat3m-JGugl9Jf3PHlxuPenO9wCWmjqiqV2UZ2IBMA_0b2ID8Uk1Ukwozo206pIjMGCEm5rK6e24u33ZDaSUUvnVzfsMQX6aY4BoleEeCGB3PMBfh4VER_I5Qsac0CHXkwtvVu5kuefZWrr9qr5MEOPyL8_tpkKow/s1600/Naveen%20Stamp.jpg",
        contact: {
            phone: "+91 90535 75169",
            email: "info@tirangayuvasamiti.org",
            web: "www.tirangayuvasamiti.org",
            address: "VPO Khanda 9R, Tehsil Kharkhoda, Sonipat, Haryana – 131402"
        }
    };

    let CACHED_LOGO = CONFIG.logoUrl;
    let CACHED_STAMP = CONFIG.stampUrl;
    let ALL_MEMBERS = [];

    // Preload Images
    function preloadImage(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function() {
            var reader = new FileReader();
            reader.onloadend = function() { callback(reader.result); }
            reader.readAsDataURL(xhr.response);
        };
        xhr.onerror = function() { callback(url); };
        xhr.open('GET', url);
        xhr.responseType = 'blob';
        xhr.send();
    }
    preloadImage(CONFIG.logoUrl, (data) => CACHED_LOGO = data);
    preloadImage(CONFIG.stampUrl, (data) => CACHED_STAMP = data);

    const FIELD = {
        first: "firstname", 
        last: "lastname", 
        father: "father_name", 
        id: "id", 
        role: "membership", 
        issueDate: "joined", 
        phone: "phone",
        photo: "photo_url", 
        qr: "qr_code_url"
    };

    function formatDate(raw) {
        if (!raw) return '________';
        let dateObj;
        if (typeof raw === 'number') {
            dateObj = new Date(Math.round((raw - 25569) * 86400 * 1000));
        } else {
            const str = String(raw).trim();
            if(str.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = str.split('-');
                return `${parts[2]}-${parts[1]}-${parts[0]}`; 
            }
            dateObj = new Date(str);
        }
        if (!isNaN(dateObj.getTime())) {
            const d = String(dateObj.getDate()).padStart(2, '0');
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const y = dateObj.getFullYear();
            return `${d}-${m}-${y}`;
        }
        return raw;
    }

    document.addEventListener('DOMContentLoaded', () => {
       loadFromConfiguredUrl();
    });

    async function loadFromConfiguredUrl() {
        const msg = document.querySelector('#tys-wrapper #status-msg');
        msg.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Establishing a secure connection to our database. Kindly wait.';

        try {
            const response = await fetch(EXCEL_FILE_URL + "&t=" + new Date().getTime());
            
            if (!response.ok) throw new Error("Network Error");
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const wb = XLSX.read(data, {type: 'array', cellDates: true});
            
            ALL_MEMBERS = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            if(ALL_MEMBERS.length) {
                msg.innerHTML = `✅ Database Connected. Secure Verification Ready.`;
            } else { msg.innerHTML = "Database is empty."; }
        } catch (error) {
            console.error(error);
            msg.innerHTML = `<span style="color:#ff6b6b">❌ Failed to connect. Check internet connection.</span>`;
        }
    }

    function verifyAndSearch() {
        const idInput = document.querySelector('#tys-wrapper #inputId').value.trim().toLowerCase();
        const phoneInput = document.querySelector('#tys-wrapper #inputPhone').value.trim().toLowerCase();
        const msg = document.querySelector('#tys-wrapper #status-msg');
        const grid = document.querySelector('#tys-wrapper #grid-area');

        if(!idInput || !phoneInput) {
            msg.innerHTML = '<span style="color:#e67e22">⚠ Error: Both Member ID and Phone are required.</span>';
            grid.innerHTML = "";
            return;
        }

        msg.innerHTML = "Verifying credentials...";

        const filtered = ALL_MEMBERS.filter(member => {
            const mID = String(member[FIELD.id] || '').toLowerCase().trim();
            const mPhone = String(member[FIELD.phone] || '').toLowerCase().trim();
            return mID.includes(idInput) && mPhone.includes(phoneInput);
        });

        if(filtered.length === 0) {
            msg.innerHTML = '<span style="color:#ff6b6b">❌ Access Denied: Invalid ID or Phone Number.</span>';
            grid.innerHTML = "";
        } else {
            msg.innerHTML = `✅ Verified! Found ${filtered.length} member(s).`;
            drawCards(filtered);
        }
    }

    function drawCards(data) {
        const grid = document.querySelector('#tys-wrapper #grid-area');
        grid.innerHTML = "";

        data.slice(0, 1).forEach((row, i) => {
            const fName = (row[FIELD.first] || '').trim();
            const lName = (row[FIELD.last] || '').trim();
            const father = (row[FIELD.father] || '').trim();
            const fullName = (fName + ' ' + lName).trim() || 'MEMBER NAME';
            const fatherDisplay = father || '_______________';
            const memID = row[FIELD.id] || '000';
            const membershipType = row[FIELD.role] || 'Lifetime'; 
            const issueDate = formatDate(row[FIELD.issueDate]);
            const memberPhone = row[FIELD.phone] || '_______________'; 
            const photo = row[FIELD.photo] || 'https://via.placeholder.com/150x200?text=PHOTO';

            // --- QR URL LOGIC ---
            let slugName = fName;
            if (lName) { slugName += " " + lName; } 
            else if (father) { slugName += " " + father; }

            const slug = slugName.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-');
            const finalQrUrl = `https://www.tirangayuvasamiti.org/tiranga-yuva-members/${slug}/`;
            // --------------------

            const frontId = `card-front-${i}`;
            const backId = `card-back-${i}`;
            const qrId = `qr-${i}`;
            const wrapperId = `wrapper-${i}`;

            const html = `
            <div class="member-row" id="${wrapperId}">
                <div class="preview-col">
                    <div class="preview-label">Front Side (Vertical)</div>
                    <div class="id-card-wrapper" id="${frontId}">
                        <div class="id-card">
                            <div class="v-header">
                                <img src="${CACHED_LOGO}" class="v-header-logo">
                                <div class="v-org-name">${CONFIG.ngoName}</div>
                            </div>

                            <div class="v-body">
                                <img src="${CACHED_LOGO}" class="v-watermark-big">
                                
                                <div class="v-photo-frame">
                                    <img src="${photo}" class="v-user-photo">
                                </div>
                                <img src="${CACHED_STAMP}" class="v-stamp">

                                <div class="v-name-block">
                                    <div class="v-name-text">${fullName}</div>
                                    <div class="v-role-badge">${membershipType} Member</div>
                                </div>

                                <div class="v-details-table">
                                    <div class="v-row"><div class="v-lbl">FATHER</div><div class="v-val">${fatherDisplay}</div></div>
                                    <div class="v-row"><div class="v-lbl">ID NO.</div><div class="v-val">TYS-${memID}</div></div>
                                    <div class="v-row"><div class="v-lbl">PHONE</div><div class="v-val">${memberPhone}</div></div>
                                    <div class="v-row"><div class="v-lbl">ISSUED</div><div class="v-val">${issueDate}</div></div>
                                </div>

                                <div class="v-qr-area">
                                    <div id="${qrId}" class="v-qr-box"></div>
                                </div>
                            </div>

                            <div class="v-footer">
                                ${CONFIG.ngoSub}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-col">
                    <div class="preview-label">Back Side (Vertical)</div>
                    <div class="id-card-wrapper" id="${backId}">
                        <div class="id-card">
                            <div class="vb-container">
                                <div class="vb-header">
                                    OFFICIAL IDENTIFICATION
                                </div>
                                <div class="vb-body">
                                    <img src="${CACHED_LOGO}" class="vb-logo-faint">
                                    <div class="vb-text-group">
                                        <div class="vb-label">If found, please return to:</div>
                                        <div class="vb-ngo-name">${CONFIG.ngoName}</div>

                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-location-dot"></i></div>
                                            <div class="vb-data">${CONFIG.contact.address}</div>
                                        </div>
                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-phone"></i></div>
                                            <div class="vb-data">${CONFIG.contact.phone}</div>
                                        </div>
                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-envelope"></i></div>
                                            <div class="vb-data">${CONFIG.contact.email}</div>
                                        </div>
                                        <div class="vb-contact-row">
                                            <div class="vb-icon"><i class="fa-solid fa-globe"></i></div>
                                            <div class="vb-data">${CONFIG.contact.web}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="vb-footer">
                                    <div class="vb-disclaimer">Property of ${CONFIG.ngoName}. Invalid without seal.</div>
                                    <div class="vb-strip"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 
                <button class="print-btn" onclick="printDoubleSided('${frontId}', '${backId}')">
                    <i class="fa-solid fa-print" style="font-size:24px;"></i>
                    <span>PRINT<br>CARD</span>
                </button>
            </div>
            `;
            grid.innerHTML += html;

            // === CRITICAL FIX: CONVERT CANVAS TO IMAGE ON LOAD ===
            setTimeout(() => { 
                const qrDiv = document.getElementById(qrId);
                qrDiv.innerHTML = ""; // Clear existing
                
                // 1. Create temporary container to hold canvas
                const tempContainer = document.createElement('div');
                
                // 2. Generate QR on temp container
                new QRCode(tempContainer, { 
                    text: finalQrUrl, 
                    width: 128, // Generate high res
                    height: 128, 
                    correctLevel: QRCode.CorrectLevel.H 
                });

                // 3. Extract the canvas
                const canvas = tempContainer.querySelector('canvas');
                if(canvas) {
                    // 4. Convert to PNG Image Data URL
                    const imgUrl = canvas.toDataURL("image/png");
                    
                    // 5. Create real IMG tag (Printers love IMG tags, hate Canvas)
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'block'; // Remove inline spacing
                    
                    // 6. Append Image to the Card
                    qrDiv.appendChild(img);
                }
            }, 100);
        });
    }

    function printDoubleSided(frontId, backId) {
        const frontHTML = document.getElementById(frontId).innerHTML;
        const backHTML = document.getElementById(backId).innerHTML;
        
        const win = window.open('', '', 'height=600,width=800');
        win.document.write('<html><head><title>Print ID Card</title>');
        win.document.write(`
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
            <style>
                @page { size: 54mm 85.6mm; margin: 0; }
                body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .print-page { width: 54mm; height: 85.6mm; position: relative; overflow: hidden; font-family: 'Montserrat', sans-serif; page-break-after: always; }
                .id-card { width: 100%; height: 100%; position: relative; background:white; display:flex; flex-direction:column;}
                 
                /* REPEAT CSS FROM MAIN STYLE TO ENSURE PRINT HAS IT */
                .v-header { height: 18%; background: #FF9933; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 2; padding-top: 2px; }
                .v-header-logo { width: 8mm; height: auto; margin-bottom: 2px; }
                .v-org-name { font-size: 8pt; font-weight: 800; color: white; text-transform: uppercase; margin: 0; line-height: 1.1; text-align: center; width: 90%; }
                .v-body { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; padding-top: 4mm; }
                .v-watermark-big { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40mm; opacity: 0.06; filter: grayscale(100%); z-index: 0; }
                .v-photo-frame { width: 22mm; height: 26mm; border: 1.5px solid #FF9933; padding: 1px; background: white; border-radius: 4px; position: relative; z-index: 2; margin-bottom: 3mm; }
                .v-user-photo { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
                .v-stamp { position: absolute; top: 22mm; right: 10mm; width: 22mm; height: 11mm; transform: rotate(-25deg); opacity: 0.85; mix-blend-mode: multiply; z-index: 10; }
                .v-name-block { text-align: center; margin-bottom: 4mm; z-index: 2; width: 90%; }
                .v-name-text { font-size: 11pt; font-weight: 800; color: #000080; text-transform: uppercase; line-height: 1.2; }
                .v-role-badge { background: #000080; color: white; font-size: 5pt; font-weight: 700; padding: 1.5px 6px; border-radius: 10px; display: inline-block; margin-top: 2px; text-transform: uppercase; }
                .v-details-table { width: 85%; font-size: 6.5pt; z-index: 2; margin-bottom: auto; }
                .v-row { display: flex; margin-bottom: 2px; border-bottom: 0.5px dotted #ddd; padding-bottom: 1px; }
                .v-lbl { width: 40%; font-weight: 700; color: #666; }
                .v-val { width: 60%; font-weight: 700; color: #000; text-align: right; }
                .v-qr-area { margin-bottom: 3mm; z-index: 2; }
                .v-qr-box { width: 14mm; height: 14mm; padding: 1px; background: white; border: 1px solid #ccc; }
                .v-qr-box img { width: 100%; height: 100%; }
                .v-footer { height: 6%; background: #138808; width: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 5pt; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }

                /* BACK SIDE PRINT CSS */
                .vb-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
                .vb-header { height: 12%; background: #FF9933; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 8pt; text-transform: uppercase; }
                .vb-body { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 5mm; text-align: center; position: relative; }
                .vb-logo-faint { width: 30mm; opacity: 0.05; margin-bottom: 5mm; filter: grayscale(100%); }
                .vb-text-group { z-index: 2; width: 100%; }
                .vb-label { font-size: 5pt; color: #999; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
                .vb-ngo-name { font-size: 9pt; font-weight: 800; color: #FF9933; text-transform: uppercase; margin-bottom: 5mm; line-height: 1.2; }
                .vb-contact-row { display: flex; align-items: flex-start; gap: 2mm; font-size: 6pt; color: #444; margin-bottom: 3mm; text-align: left; }
                .vb-icon { color: #138808; width: 4mm; text-align: center; font-size: 7pt; }
                .vb-data { flex: 1; line-height: 1.3; }
                .vb-footer { height: auto; padding-bottom: 3mm; text-align: center; }
                .vb-disclaimer { font-size: 4pt; color: #aaa; font-style: italic; padding: 0 4mm; margin-bottom: 2mm; }
                .vb-strip { height: 4mm; background: #138808; width: 100%; }
            </style>
        `);
        win.document.write('</head><body>');
        
        win.document.write('<div class="print-page">');
        win.document.write(frontHTML);
        win.document.write('</div>');

        win.document.write('<div class="print-page">');
        win.document.write(backHTML);
        win.document.write('</div>');
        
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        setTimeout(() => { win.print(); }, 1000);
    }
</script>
